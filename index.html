<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Âú®Á∫øÂçúÂç¶ (‰ºòÂåñÁâà)</title>
    
    <!-- ÂºïÂÖ• GSAP Âä®ÁîªÂ∫ì -->
    <script src="https://cdn.jsdelivr.net/npm/gsap@3.12.5/dist/gsap.min.js"></script>
    <script src="data.js" defer></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;700&display=swap');

        :root {
            /* ÊöóËâ≤‰∏ªÈ¢ò (ÈªòËÆ§) */
            --bg-color: #1a1a1a;
            --container-bg: rgba(44, 44, 44, 0.55);
            --primary-text: #e0e0e0;
            --title-color: #d4af37;
            --border-color: #444;
            --button-bg: #8c735b;
            --button-hover-bg: #a0856a;
            --hexagram-bg: #333;
            --changing-yao-color: #ff5555;
            --glow-color: rgba(212, 175, 55, 0.7);
            --original-hex-color: #61afef;
            --changed-hex-color: #e06c75;
            --stalk-color: #f0e68c; /* ËìçËçâÈ¢úËâ≤ */
            --modal-bg: rgba(44, 44, 44, 0.85);
            --modal-border: #555;
        }
        
        /* Êòé‰∫Æ‰∏ªÈ¢ò */
        :root.light-theme {
            --bg-color: #f5f0e8;
            --container-bg: rgba(255, 255, 255, 0.7);
            --primary-text: #333333;
            --title-color: #9c7c38;
            --border-color: #d0c8b0;
            --button-bg: #b39b6f;
            --button-hover-bg: #c9af7e;
            --hexagram-bg: #f0e8d8;
            --changing-yao-color: #d04848;
            --glow-color: rgba(179, 155, 111, 0.5);
            --original-hex-color: #3a7ab3;
            --changed-hex-color: #b34c55;
            --stalk-color: #d4c88c;
            --modal-bg: rgba(255, 255, 255, 0.9);
            --modal-border: #d0c8b0;
        }

        body {
            font-family: 'Noto Serif SC', serif;
            background-color: var(--bg-color);
            color: var(--primary-text);
            margin: 0;
            padding: 10px;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            -webkit-tap-highlight-color: transparent;
            transition: background-color 0.5s ease;
            overflow: hidden;
            perspective: 1000px;
        }

        #background-bagua {
            position: fixed;
            top: 50%;
            left: 50%;
            width: 80vmax;
            height: 80vmax;
            transform: translate(-50%, -50%);
            z-index: -1;
            opacity: 0.08;
            animation: slow-rotate 120s linear infinite;
        }

        @keyframes slow-rotate {
            from { transform: translate(-50%, -50%) rotate(0deg); }
            to { transform: translate(-50%, -50%) rotate(360deg); }
        }

        body.divining {
            background-color: #000;
        }
        body.divining::before {
            content: '';
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: radial-gradient(circle at center, transparent 40%, #000 85%);
            z-index: 99;
            pointer-events: none;
            opacity: 0;
            animation: fadeInVignette 1s ease forwards;
        }

        @keyframes fadeInVignette { to { opacity: 1; } }

        .container {
            max-width: 800px; width: 95%; margin: auto; padding: 30px;
            background-color: var(--container-bg);
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
            border: 1px solid var(--border-color);
            box-sizing: border-box;
            transition: opacity 0.5s ease, transform 0.2s ease-out;
            opacity: 0;
            animation: fadeInContainer 1s 0.2s ease forwards;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            transform-style: preserve-3d;
            max-height: 95vh;
            overflow-y: auto;
        }

        @keyframes fadeInContainer { to { opacity: 1; } }

        h1, h2, h3 { color: var(--title-color); text-align: center; font-weight: 700; }
        h1 { font-size: 2.2em; margin-bottom: 25px; }
        h2 { border-bottom: 1px solid var(--border-color); padding-bottom: 15px; margin-top: 40px; margin-bottom: 20px; }
        .section p { text-align: center; line-height: 1.8; font-size: 1.1em; margin-bottom: 20px; }
        
        .method-selector {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 25px;
        }
        .method-selector label {
            margin: 0 10px;
            font-size: 1.1em;
            color: var(--primary-text);
            opacity: 0.7;
            transition: opacity 0.3s ease;
        }
        .method-switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
        }
        .method-switch input { display: none; }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: #444;
            transition: .4s;
            border-radius: 34px;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 26px; width: 26px;
            left: 4px; bottom: 4px;
            background-color: var(--button-bg);
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .slider { background-color: var(--title-color); }
        input:checked + .slider:before { transform: translateX(26px); }
        #label-yarrow { opacity: 1; }

        .button-wrapper { text-align: center; margin-top: 20px; position: relative; min-height: 60px; display: flex; justify-content: center; align-items: center; gap: 15px;}
        button {
            font-family: inherit; font-size: 1.2em; padding: 12px 25px; background-color: var(--button-bg);
            color: white; border: none; border-radius: 8px; cursor: pointer; transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            position: relative;
            overflow: hidden;
        }
        button:hover:not(:disabled) { 
            background-color: var(--button-hover-bg); 
            transform: translateY(-2px); 
            box-shadow: 0 6px 20px var(--glow-color); 
        }
        button:active:not(:disabled) { transform: translateY(0); box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
        button:disabled { background-color: #555; color: #888; cursor: not-allowed; }

        /* --- ÂçïÁã¨ËÆæÁΩÆÂç¶Ë±°Ëß£ÈáäÊåâÈíÆÈ¢úËâ≤ --- */
        #interp-button {
            background-color: #c93756; /* Êú±Á∫¢Ëâ≤ */
        }
        #interp-button:hover:not(:disabled) {
            background-color: #e04a69; /* ÊÇ¨ÂÅúÊó∂Êõ¥‰∫ÆÁöÑÊú±Á∫¢Ëâ≤ */
        }

        .button-glow-effect {
            position: absolute; top: 50%; left: 50%; width: 10px; height: 10px;
            background: var(--title-color); border-radius: 50%;
            transform: translate(-50%, -50%) scale(0); opacity: 0.7;
            animation: button-glow 0.6s ease-out;
        }
        @keyframes button-glow { to { transform: translate(-50%, -50%) scale(20); opacity: 0; } }

        .loader {
            width: 18px; height: 18px; border: 2px solid #FFF; border-bottom-color: transparent;
            border-radius: 50%; display: inline-block; box-sizing: border-box;
            animation: rotation 1s linear infinite; margin-left: 10px; vertical-align: middle;
        }
        @keyframes rotation { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* È°µÈù¢Âä†ËΩΩÂä®ÁîªÊ†∑Âºè */
        #page-loader {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--bg-color);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            transition: opacity 0.5s ease, visibility 0.5s ease;
        }
        .loader-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
        }
        .loader-symbol {
            font-size: 4rem;
            color: var(--title-color);
            animation: float 2s ease-in-out infinite, rotate 6s linear infinite;
            text-shadow: 0 0 15px var(--glow-color);
        }
        .loader-text {
            color: var(--primary-text);
            font-size: 1.2rem;
            letter-spacing: 3px;
        }
        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-15px); }
        }
        @keyframes rotate {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        #interactive-animation-container {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,6.6);
            z-index: 100;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            opacity: 0; pointer-events: none; transition: opacity 0.5s ease;
        }
        #interactive-animation-container.visible { opacity: 1; pointer-events: all; }
        #interaction-prompt { color: var(--title-color); font-size: 1.5em; margin-bottom: 20px; text-shadow: 0 0 10px var(--glow-color); min-height: 1.5em;}
        #stalks-wrapper {
            width: 80%; max-width: 500px; height: 150px;
            display: flex; justify-content: center; align-items: center;
            cursor: pointer; border: 2px dashed var(--border-color); border-radius: 10px;
            padding: 10px; position: relative;
        }
        .stalk {
            position: absolute; width: 2px; height: 100px;
            background: linear-gradient(to right, transparent, var(--stalk-color) 25%, var(--stalk-color) 75%, transparent);
            border-radius: 2px;
            transform-origin: bottom center;
            will-change: transform, opacity;
        }

        #yao-stats-container {
            position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); width: 90%; max-width: 400px;
            background: rgba(0,0,0,0.5); border-radius: 8px; padding: 10px; border: 1px solid var(--border-color);
            display: flex; flex-direction: column; align-items: center; gap: 8px; opacity: 0;
            transition: opacity 0.5s ease; color: var(--primary-text);
        }
        .yao-stats-title { font-size: 1em; color: var(--title-color); font-weight: bold; }
        .yao-stats-changes { display: flex; justify-content: center; gap: 10px; width: 100%; }
        .change-stat { background: rgba(255,255,255,0.1); padding: 5px 8px; border-radius: 4px; font-size: 0.8em; text-align: center; }
        .change-stat .label { font-size: 0.9em; opacity: 0.7; }
        .change-stat .value { font-weight: bold; margin-top: 2px; }
        .yao-stats-result { font-size: 1.1em; font-weight: bold; margin-top: 5px; background: var(--button-bg); padding: 4px 12px; border-radius: 5px; }

        #result-container { display: none; margin-top: 30px; }
        .hexagram-display { display: flex; justify-content: space-around; margin-top: 20px; padding: 20px; background-color: var(--hexagram-bg); border-radius: 8px; border: 1px solid var(--border-color); }
        .hexagram { display: flex; flex-direction: column; align-items: center; text-align: center; }
        .hexagram h3 { font-size: 1.5em; margin-bottom: 15px; }
        .yao-lines { display: flex; flex-direction: column-reverse; }
        .hexagram-name { margin-top: 15px; font-size: 1.8em; font-weight: bold; height: 1.5em; letter-spacing: 2px; text-shadow: 0 0 8px rgba(0,0,0,0.5); }
        #original-hexagram-name { color: var(--original-hex-color); }
        #changed-hexagram-name { color: var(--changed-hex-color); }
        .yao { display: flex; justify-content: center; align-items: center; height: 25px; margin: 8px 0; position: relative; width: 120px; }
        .yao svg { width: 100%; height: 8px; display: block; }
        .yao svg line { stroke: var(--primary-text); transition: stroke 0.3s ease; }
        .yao.yao-changing svg line { stroke: var(--changing-yao-color); }
        .yao-changing-symbol { position: absolute; right: -25px; top: 50%; transform: translateY(-50%); font-size: 1.2em; color: var(--changing-yao-color); font-weight: bold; }
        
        /* --- Ëß£ÈáäÂºπÁ™óÊ†∑Âºè --- */
        #interpretation-modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.7); 
            backdrop-filter: blur(5px);
            z-index: 200; display: flex; justify-content: center; align-items: center;
            opacity: 0; pointer-events: none; transition: opacity 0.3s ease;
        }
        #interpretation-modal-overlay.visible { opacity: 1; pointer-events: all; }
        #interpretation-modal {
            width: 90%; max-width: 600px; background: var(--container-bg);
            border-radius: 10px; border: 1px solid var(--border-color);
            box-shadow: 0 10px 40px rgba(0,0,0,0.5); display: flex; flex-direction: column;
            max-height: 80vh; transform: scale(0.9); transition: transform 0.3s ease;
        }
        #interpretation-modal-overlay.visible #interpretation-modal { transform: scale(1); }
        #modal-header { display: flex; justify-content: space-between; align-items: center; padding: 10px 20px; border-bottom: 1px solid var(--border-color); flex-shrink: 0; }
        #modal-tabs { display: flex; gap: 10px; }
        
        /* ‰∏ªÈ¢òÂàáÊç¢ÊåâÈíÆÊ†∑Âºè */
        #theme-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--container-bg);
            border-radius: 20px;
            padding: 5px 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 100;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            border: 1px solid var(--border-color);
            transition: all 0.3s ease;
        }
        #theme-toggle:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px var(--glow-color);
        }
        .theme-icon {
            font-size: 1.2rem;
            padding: 5px;
            transition: opacity 0.3s ease;
        }
        :root:not(.light-theme) #theme-icon-light {
            opacity: 0.3;
        }
        :root.light-theme #theme-icon-dark {
            opacity: 0.3;
        }
        
        /* ÈóÆÈ¢òËæìÂÖ•Ê°ÜÊ†∑Âºè */
        .question-input-container {
            margin: 20px auto;
            width: 90%;
            max-width: 500px;
        }
        #question-input {
            width: 100%;
            padding: 12px 15px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            background: rgba(0,0,0,0.2);
            color: var(--primary-text);
            font-family: inherit;
            font-size: 1.1em;
            transition: all 0.3s ease;
            text-align: center;
        }
        #question-input:focus {
            outline: none;
            border-color: var(--title-color);
            box-shadow: 0 0 10px var(--glow-color);
        }
        :root.light-theme #question-input {
            background: rgba(255,255,255,0.7);
        }
        
        /* ÂéÜÂè≤ËÆ∞ÂΩïÊ†∑Âºè */
        #history-button {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: auto;
            height: 50px;
            padding: 0 20px;
            border-radius: 25px;
            background: var(--button-bg);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            cursor: pointer;
            z-index: 100;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            border: none;
            transition: all 0.3s ease;
            font-size: 1rem;
            font-weight: bold;
        }
        #history-button:hover {
            transform: translateY(-2px);
            background: var(--button-hover-bg);
            box-shadow: 0 4px 15px var(--glow-color);
        }
        .history-icon {
            font-size: 1.2rem;
            transition: transform 0.3s ease;
        }
        .history-text {
            display: none;
        }
        @media (min-width: 768px) {
            .history-text {
                display: inline;
            }
        }
        #history-button:hover .history-icon {
            transform: rotate(15deg);
        }
        #history-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            backdrop-filter: blur(5px);
            z-index: 200;
            display: flex;
            justify-content: center;
            align-items: center;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }
        #history-modal-overlay.visible {
            opacity: 1;
            pointer-events: all;
        }
        #history-modal {
            width: 90%;
            max-width: 600px;
            background: var(--modal-bg);
            border-radius: 10px;
            border: 1px solid var(--modal-border);
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
            max-height: 80vh;
            display: flex;
            flex-direction: column;
            transform: scale(0.9);
            transition: transform 0.3s ease;
        }
        #history-modal-overlay.visible #history-modal {
            transform: scale(1);
        }
        #history-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            border-bottom: 1px solid var(--border-color);
        }
        #history-title {
            font-size: 1.3em;
            color: var(--title-color);
            font-weight: bold;
        }
        #history-close-btn {
            background: none;
            border: none;
            color: var(--primary-text);
            font-size: 2em;
            cursor: pointer;
            opacity: 0.7;
            transition: opacity 0.2s;
            padding: 0;
            line-height: 1;
        }
        #history-close-btn:hover {
            opacity: 1;
        }
        #history-content {
            padding: 20px;
            overflow-y: auto;
            max-height: calc(80vh - 60px);
        }
        .history-item {
            padding: 15px;
            border-radius: 8px;
            background: rgba(0,0,0,0.1);
            margin-bottom: 15px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .history-item:hover {
            background: rgba(0,0,0,0.2);
            transform: translateY(-2px);
        }
        .history-date {
            font-size: 0.8em;
            color: var(--primary-text);
            opacity: 0.7;
            margin-bottom: 5px;
        }
        .history-question {
            font-weight: bold;
            margin-bottom: 10px;
        }
        .history-hexagrams {
            display: flex;
            gap: 15px;
        }
        .history-hexagram {
            text-align: center;
        }
        .history-hexagram-name {
            font-size: 1.1em;
            color: var(--title-color);
        }
        .no-history {
            text-align: center;
            padding: 30px;
            color: var(--primary-text);
            opacity: 0.7;
        }
        .modal-tab {
            background: transparent; border: 2px solid transparent; color: var(--primary-text);
            opacity: 0.6; padding: 8px 16px; font-size: 1em; border-radius: 6px;
            cursor: pointer; transition: all 0.3s ease;
        }
        .modal-tab.active { opacity: 1; color: var(--title-color); border-bottom-color: var(--title-color); }
        #modal-close-btn { background: none; border: none; color: var(--primary-text); font-size: 2.5em; cursor: pointer; opacity: 0.7; transition: opacity 0.2s; padding: 0; line-height: 1; }
        #modal-close-btn:hover { opacity: 1; }
        #modal-content { padding: 25px; overflow-y: auto; line-height: 1.9; font-size: 1.1em; white-space: pre-wrap; }
        .tab-content { display: none; }
        .tab-content.active { display: block; animation: contentFadeIn 0.5s ease; }
        @keyframes contentFadeIn { from { opacity: 0; } to { opacity: 1; } }

        @media (max-width: 768px) {
            body { align-items: center; padding: 0; }
            .container { padding: 15px; margin: 0 2.5%; width: 95%; border-radius: 8px; overflow: auto; }
            h1 { font-size: 1.5em; }
            .hexagram-display { flex-direction: row; justify-content: space-around; align-items: flex-start; padding: 10px 5px; }
            .hexagram { flex: 1; min-width: 0; padding: 0 5px; }
            .hexagram h3 { font-size: 1em; margin-bottom: 6px; }
            .hexagram-name { font-size: 1.1em; margin-top: 6px; word-break: break-all; }
            .yao { width: 100%; max-width: 80px; height: 14px; margin: 3px auto; }
            .yao svg { height: 3px; }
            .yao-changing-symbol { font-size: 0.8em; right: -16px;}
            #yao-stats-container { padding: 8px; gap: 5px; }
            .change-stat { font-size: 0.7em; padding: 4px 6px; }
            .yao-stats-result { font-size: 1em; }
            button { font-size: 1em; padding: 10px 18px; }
        }
    </style>
</head>
<body>
    
    <!-- Ê∑ªÂä†È°µÈù¢Âä†ËΩΩÂä®Áîª -->
    <div id="page-loader">
        <div class="loader-content">
            <div class="loader-symbol">‚òØ</div>
            <div class="loader-text">Âä†ËΩΩ‰∏≠...</div>
        </div>
    </div>

    <div id="background-bagua">
        <svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg" fill="none" stroke="currentColor" color="var(--primary-text)">
            <defs>
                <g id="yang-line"><path d="M -4.5,0 L 4.5,0" stroke-width="1.5" stroke-linecap="butt"></path></g>
                <g id="yin-line"><path d="M -4.5,0 L -1.5,0 M 1.5,0 L 4.5,0" stroke-width="1.5" stroke-linecap="butt"></path></g>
            </defs>
            <g stroke-width="0.5">
                <circle cx="50" cy="50" r="48"></circle><circle cx="50" cy="50" r="44"></circle>
                <circle cx="50" cy="50" r="35"></circle><circle cx="50" cy="50" r="34"></circle>
                <circle cx="50" cy="50" r="26"></circle><circle cx="50" cy="50" r="25"></circle>
                <circle cx="50" cy="50" r="17"></circle><circle cx="50" cy="50" r="16"></circle>
            </g>
            <g stroke-width="0">
                <path d="M50 16 A 34 34 0 0 0 50 84 Z" fill="var(--bg-color)"></path>
                <path d="M50 16 A 34 34 0 0 1 50 84 Z" fill="currentColor"></path>
                <circle cx="50" cy="67" r="17" fill="currentColor"></circle>
                <circle cx="50" cy="33" r="17" fill="var(--bg-color)"></circle>
                <circle cx="50" cy="33" r="4" fill="currentColor"></circle>
                <circle cx="50" cy="67" r="4" fill="var(--bg-color)"></circle>
            </g>
            <g transform="translate(50 50)">
                 <g transform="translate(0, -39.5)"><use href="#yang-line" y="3"></use><use href="#yang-line" y="0"></use><use href="#yang-line" y="-3"></use></g>
                 <g transform="rotate(45) translate(0, -39.5)"><use href="#yin-line" y="3"></use><use href="#yang-line" y="0"></use><use href="#yang-line" y="-3"></use></g>
                 <g transform="rotate(90) translate(0, -39.5)"><use href="#yin-line" y="3"></use><use href="#yang-line" y="0"></use><use href="#yin-line" y="-3"></use></g>
                 <g transform="rotate(135) translate(0, -39.5)"><use href="#yin-line" y="3"></use><use href="#yin-line" y="0"></use><use href="#yang-line" y="-3"></use></g>
                 <g transform="rotate(180) translate(0, -39.5)"><use href="#yin-line" y="3"></use><use href="#yin-line" y="0"></use><use href="#yin-line" y="-3"></use></g>
                 <g transform="rotate(225) translate(0, -39.5)"><use href="#yang-line" y="3"></use><use href="#yin-line" y="0"></use><use href="#yin-line" y="-3"></use></g>
                 <g transform="rotate(270) translate(0, -39.5)"><use href="#yang-line" y="3"></use><use href="#yin-line" y="0"></use><use href="#yang-line" y="-3"></use></g>
                 <g transform="rotate(315) translate(0, -39.5)"><use href="#yang-line" y="3"></use><use href="#yang-line" y="0"></use><use href="#yin-line" y="-3"></use></g>
            </g>
        </svg>
    </div>
    <!-- ‰∏ªÈ¢òÂàáÊç¢ÊåâÈíÆ -->
    <div id="theme-toggle">
        <span class="theme-icon" id="theme-icon-dark">Â§ú</span>
        <span class="theme-icon" id="theme-icon-light">Êó•</span>
    </div>
    
    <div class="container" id="main-container">
        <div id="intro-section">
            <h1><b>Â§ßË°çÁ≠ÆÊ≥ï ¬∑ Âú®Á∫øÂçúÂç¶</b></h1>
            <div class="section">
                <p><i>ÂøÉËØöÂàôÁÅµÔºå‰∏Ä‰∫ã‰∏ÄÈóÆ</i></p>
            </div>
            
            <!-- Ê∑ªÂä†ÈóÆÈ¢òËæìÂÖ•Ê°Ü -->
            <div class="question-input-container">
                <input type="text" id="question-input" placeholder="ËØ∑ËæìÂÖ•ÊÇ®ÊÉ≥ÈóÆÁöÑÈóÆÈ¢ò‚Ä¶‰πüÂèØ‰ª•‰∏çËæì" maxlength="50">
            </div>
            
            <div class="method-selector">
                <label id="label-random">ÈöèÊú∫Êï∞Ê≥ï</label>
                <label class="method-switch">
                    <input type="checkbox" id="method-toggle" checked>
                    <span class="slider"></span>
                </label>
                <label id="label-yarrow"><b>Â§ßË°çÁ≠ÆÊ≥ï</b></label>
            </div>
        </div>
        
        <div class="button-wrapper">
            <button id="divine-button">ÂºÄÂßãÂçúÂç¶</button>
        </div>

        <div id="result-container">
            <div class="hexagram-display">
                <div class="hexagram">
                    <h3>Êú¨Âç¶</h3>
                    <div id="original-hexagram" class="yao-lines"></div>
                    <div id="original-hexagram-name" class="hexagram-name"></div>
                </div>
                <div class="hexagram" id="changed-hexagram-container">
                    <h3>ÂèòÂç¶</h3>
                    <div id="changed-hexagram" class="yao-lines"></div>
                    <div id="changed-hexagram-name" class="hexagram-name"></div>
                </div>
            </div>
            <!-- ÁªìÊûúÈ°µÊåâÈíÆÂÆπÂô® -->
            <div id="result-actions-wrapper" class="button-wrapper"></div>
        </div>
    </div>
    
    <div id="interactive-animation-container">
        <div id="interaction-prompt"></div>
        <div id="stalks-wrapper"></div>
        <div id="yao-stats-container">
            <div class="yao-stats-title">Êú¨ÁàªÊºîÁÆó</div>
            <div id="yao-stats-changes" class="yao-stats-changes"></div>
            <div id="yao-stats-result" class="yao-stats-result"></div>
        </div>
    </div>

    <!-- Ëß£ÈáäÂºπÁ™ó HTML -->
    <div id="interpretation-modal-overlay">
        <div id="interpretation-modal">
            <div id="modal-header">
                <div id="modal-tabs">
                    <button id="tab-original" class="modal-tab active">Êú¨Âç¶</button>
                    <button id="tab-changed" class="modal-tab">ÂèòÂç¶</button>
                </div>
                <button id="modal-close-btn">&times;</button>
            </div>
            <div id="modal-content">
                <div id="content-original" class="tab-content active"></div>
                <div id="content-changed" class="tab-content"></div>
            </div>
        </div>
    </div>
    
    <!-- ÂéÜÂè≤ËÆ∞ÂΩïÊåâÈíÆ -->
    <button id="history-button" title="Êü•ÁúãÂéÜÂè≤ËÆ∞ÂΩï">
        <span class="history-icon">üìú</span>
        <span class="history-text">ÂéÜÂè≤</span>
    </button>
    
    <!-- ÂéÜÂè≤ËÆ∞ÂΩïÊ®°ÊÄÅÊ°Ü -->
    <div id="history-modal-overlay">
        <div id="history-modal">
            <div id="history-header">
                <div id="history-title">ÂçúÂç¶ÂéÜÂè≤ËÆ∞ÂΩï</div>
                <button id="history-close-btn">&times;</button>
            </div>
            <div id="history-content">
                <!-- ÂéÜÂè≤ËÆ∞ÂΩïÂÜÖÂÆπÂ∞ÜÈÄöËøáJavaScriptÂä®ÊÄÅÁîüÊàê -->
            </div>
        </div>
    </div>

    <script>
    const app = {
        elements: {
            divineButton: document.getElementById('divine-button'),
            interactiveContainer: document.getElementById('interactive-animation-container'),
            interactionPrompt: document.getElementById('interaction-prompt'),
            stalksWrapper: document.getElementById('stalks-wrapper'),
            resultContainer: document.getElementById('result-container'),
            originalHexagram: document.getElementById('original-hexagram'),
            changedHexagram: document.getElementById('changed-hexagram'),
            originalHexagramName: document.getElementById('original-hexagram-name'),
            changedHexagramName: document.getElementById('changed-hexagram-name'),
            mainContainer: document.getElementById('main-container'),
            introSection: document.getElementById('intro-section'),
            changedHexagramContainer: document.getElementById('changed-hexagram-container'),
            methodToggle: document.getElementById('method-toggle'),
            labelYarrow: document.getElementById('label-yarrow'),
            labelRandom: document.getElementById('label-random'),
            yaoStatsContainer: document.getElementById('yao-stats-container'),
            yaoStatsChanges: document.getElementById('yao-stats-changes'),
            yaoStatsResult: document.getElementById('yao-stats-result'),
            resultActionsWrapper: document.getElementById('result-actions-wrapper'),
            interpretationModalOverlay: document.getElementById('interpretation-modal-overlay'),
        },
        
        state: {
            divinationData: [],
            isMobile: /Mobi|Android/i.test(navigator.userAgent),
            divinationMethod: 'yarrow',
            isParallaxActive: true,
            isCalibrated: false,
            baseBeta: 0,
            baseGamma: 0,
            currentOriginalHexKey: null,
            currentChangedHexKey: null,
            currentQuestion: '',
            divinationHistory: []
        },

        performChangeWithInteraction: function(totalSticks, clickRatio) {
            if (totalSticks <= 1) return { total: totalSticks, left: totalSticks, right: 0, leftRem: totalSticks, rightRem: 0, removed: 0, remaining: totalSticks };
            let leftPile = Math.round(totalSticks * clickRatio);
            if (leftPile < 1) leftPile = 1;
            if (leftPile >= totalSticks) leftPile = totalSticks - 1;
            const rightPile = totalSticks - leftPile;
            const rightPileForCounting = rightPile - 1;
            let leftRemainder = leftPile % 4;
            if (leftRemainder === 0) leftRemainder = 4;
            let rightRemainder = rightPileForCounting % 4;
            if (rightRemainder === 0) rightRemainder = 4;
            const totalRemoved = 1 + leftRemainder + rightRemainder;
            const remainingSticks = totalSticks - totalRemoved;
            return { total: totalSticks, left: leftPile, right: rightPile, leftRem: leftRemainder, rightRem: rightRemainder, removed: totalRemoved, remaining: remainingSticks };
        },
        
        getChangeFromUser: function(totalSticks, changeName) {
            return new Promise(resolve => {
                this.elements.interactionPrompt.textContent = `Á¨¨ ${changeName} ÂèòÔºåËØ∑ÁÇπÂáªÂàÜËìçËçâ`;
                this.elements.stalksWrapper.innerHTML = '';
                
                // ‰ΩøÁî® DocumentFragment ÊâπÈáèÂàõÂª∫ÂíåÊ∑ªÂä†ËìçËçâ
                const fragment = document.createDocumentFragment();
                const stalks = [];
                
                // È¢ÑÂÖàËÆ°ÁÆóÊâÄÊúâËìçËçâÁöÑÈöèÊú∫ÊóãËΩ¨Âíå‰ΩçÁßªÂÄºÔºåÈÅøÂÖçÂú®Âä®Áîª‰∏≠ÈáçÂ§çËÆ°ÁÆó
                const randomValues = Array.from({ length: totalSticks }, () => ({
                    yOffset: (Math.random() - 0.5) * 10,
                    rotation: (Math.random() - 0.5) * 15
                }));
                
                for (let i = 0; i < totalSticks; i++) {
                    const stalk = document.createElement('div');
                    stalk.className = 'stalk';
                    fragment.appendChild(stalk);
                    stalks.push(stalk);
                }
                
                // ‰∏ÄÊ¨°ÊÄßÂ∞ÜÊâÄÊúâËìçËçâÊ∑ªÂä†Âà∞ DOM
                this.elements.stalksWrapper.appendChild(fragment);
                
                // ‰ΩøÁî®È¢ÑËÆ°ÁÆóÁöÑÈöèÊú∫ÂÄºËøõË°åÂä®Áîª
                gsap.fromTo(stalks, 
                    { x: 0, y: 0, rotation: 0 }, 
                    { 
                        x: (i) => (i - totalSticks / 2) * (this.elements.stalksWrapper.offsetWidth * 0.8 / totalSticks),
                        y: (i) => randomValues[i].yOffset,
                        rotation: (i) => randomValues[i].rotation,
                        duration: 0.5,
                        ease: 'power2.out'
                    });
                
                    const clickHandler = (e) => {
                    this.elements.stalksWrapper.removeEventListener('click', clickHandler);
                    this.elements.stalksWrapper.style.cursor = 'default';
                    
                    const rect = this.elements.stalksWrapper.getBoundingClientRect();
                    const clickX = e.clientX - rect.left;
                    const clickRatio = clickX / rect.width;
                    const changeResult = this.performChangeWithInteraction(totalSticks, clickRatio);
                    
                    this.elements.interactionPrompt.textContent = `Â§©: ${changeResult.left}, Âú∞: ${changeResult.right}`;
                    
                    const tl = gsap.timeline({ onComplete: () => resolve(changeResult) });
                    const leftStalks = stalks.slice(0, changeResult.left);
                    const rightStalks = stalks.slice(changeResult.left);

                    tl.to(leftStalks, { x: '-=100', rotation: -20, duration: 0.3, ease: 'power2.inOut', stagger: 0.005 });
                    tl.to(rightStalks, { x: '+=100', rotation: 20, duration: 0.3, ease: 'power2.inOut', stagger: 0.005 }, '<');
                    const heldStalk = rightStalks.pop();
                    tl.to(heldStalk, { y: -80, x: '+=20', rotation: 15, duration: 0.3, ease: 'power2.out' }, '-=0.2');
                    const leftRemainderStalks = leftStalks.slice(0, changeResult.leftRem);
                    const rightRemainderStalks = rightStalks.slice(0, changeResult.rightRem);
                    const nonRemainderLeft = leftStalks.filter(s => !leftRemainderStalks.includes(s));
                    const nonRemainderRight = rightStalks.filter(s => !rightRemainderStalks.includes(s));
                    tl.to([...nonRemainderLeft, ...nonRemainderRight], { opacity: 0.3, duration: 0.2 }, '+=0.1');
                    tl.to(leftRemainderStalks, { x: '-=30', scale: 1.2, duration: 0.3, ease: 'power2.out' }, '<');
                    tl.to(rightRemainderStalks, { x: '+=30', scale: 1.2, duration: 0.3, ease: 'power2.out' }, '<');
                    const allRemainders = [heldStalk, ...leftRemainderStalks, ...rightRemainderStalks];
                    const stalksWrapperRect = this.elements.stalksWrapper.getBoundingClientRect();
                    const targetX = (window.innerWidth / 2) - (stalksWrapperRect.left + stalksWrapperRect.width / 2);
                    const targetY = (window.innerHeight / 2) - (stalksWrapperRect.top + stalksWrapperRect.height / 2);
                    tl.to(allRemainders, { x: targetX, y: targetY, scale: 1, duration: 0.5, stagger: 0.05, ease: 'power2.inOut' }, '-=0.3');
                    tl.to(allRemainders, { y: `+=${window.innerHeight / 2 + 100}`, opacity: 0, duration: 0.6, stagger: 0.03, ease: 'power2.in' });
                    const remainingStalks = stalks.filter(s => !allRemainders.includes(s));
                    tl.to(remainingStalks, { x: 0, rotation: 0, opacity: 1, duration: 0.4, ease: 'power2.inOut' }, '-=0.5');
                };
                this.elements.stalksWrapper.addEventListener('click', clickHandler);
                this.elements.stalksWrapper.style.cursor = 'pointer';
            });
        },

        generateYaoInteractively: async function() {
            let sticks = 49;
            const changes = [];
            
            this.elements.yaoStatsChanges.innerHTML = '';
            this.elements.yaoStatsResult.innerHTML = '';
            gsap.to(this.elements.yaoStatsContainer, { opacity: 1, duration: 0.3 });

            for (let i = 0; i < 3; i++) {
                const changeNames = ['‰∏Ä', '‰∫å', '‰∏â'];
                const changeResult = await this.getChangeFromUser(sticks, changeNames[i]);
                sticks = changeResult.remaining;
                changes.push(changeResult);

                const changeStatEl = document.createElement('div');
                changeStatEl.className = 'change-stat';
                changeStatEl.innerHTML = `<div class="label">Á¨¨${changeNames[i]}Âèò</div><div class="value">‰Ωô ${changeResult.remaining}</div>`;
                this.elements.yaoStatsChanges.appendChild(changeStatEl);
                gsap.from(changeStatEl, { opacity: 0, scale: 0.5, duration: 0.4, ease: 'back.out' });
            }
            const yaoValue = sticks / 4;
            const yaoInfo = this.getYaoInfo(yaoValue);
            
            this.elements.yaoStatsResult.textContent = `Êú¨ÁàªËìçËçâ: ${yaoValue * 4} Ê†π`;
            gsap.from(this.elements.yaoStatsResult, { opacity: 0, y: 10, duration: 0.4 });

            return { value: yaoValue, changes: changes, info: yaoInfo };
        },

        animateFinalHexagramFormation: async function(yaoInfos) {
            const finalStalks = Array.from(this.elements.stalksWrapper.querySelectorAll('.stalk')).filter(s => gsap.getProperty(s, "opacity") > 0);
            const flyingHexagram = document.createElement('div');
            flyingHexagram.style.position = 'absolute';
            flyingHexagram.style.display = 'flex';
            flyingHexagram.style.flexDirection = 'column-reverse';
            yaoInfos.forEach(info => {
                const yaoEl = this.createYaoElement(info);
                flyingHexagram.appendChild(yaoEl);
            });
            this.elements.stalksWrapper.appendChild(flyingHexagram);
            flyingHexagram.style.opacity = 0;
            const tl = gsap.timeline();
            tl.to(this.elements.yaoStatsContainer, { opacity: 0, duration: 0.3 });
            tl.to(finalStalks, { x: 0, y: 0, opacity: 0, scale: 0, duration: 0.8, stagger: 0.02, ease: 'power2.in' }, "<");
            tl.to(flyingHexagram, { opacity: 1, duration: 0.5 }, '-=0.5');
            const viewportCenterX = window.innerWidth / 2;
            const viewportCenterY = window.innerHeight / 2;
            const wrapperRect = this.elements.stalksWrapper.getBoundingClientRect();
            tl.to(flyingHexagram, { x: viewportCenterX - wrapperRect.left - wrapperRect.width / 2, y: viewportCenterY - wrapperRect.top - wrapperRect.height / 2, scale: 0, opacity: 0, duration: 1.2, ease: 'power3.in' }, '+=0.5');
            await new Promise(resolve => tl.eventCallback('onComplete', resolve));
        },

        runYarrowDivination: async function() {
            this.elements.interactiveContainer.classList.add('visible');
            this.elements.yaoStatsContainer.style.opacity = 0;
            this.state.divinationData = [];
            const originalYaoValues = [];
            const originalYaoInfos = [];
            const yaoNames = ['Âàù', '‰∫å', '‰∏â', 'Âõõ', '‰∫î', '‰∏ä'];
            for (let i = 0; i < 6; i++) {
                this.elements.interactionPrompt.textContent = `Ê±Ç ${yaoNames[i]} Áàª`;
                await new Promise(r => setTimeout(r, 200));
                const yaoResult = await this.generateYaoInteractively();
                originalYaoValues.push(yaoResult.value);
                originalYaoInfos.push(yaoResult.info);
                this.state.divinationData.push(yaoResult);
            }
            this.elements.interactionPrompt.textContent = 'Âç¶Ë±°ÁîüÊàê...';
            await this.animateFinalHexagramFormation(originalYaoInfos);
            this.elements.interactiveContainer.classList.remove('visible');
            return originalYaoValues;
        },

        runRandomDivination: async function() {
            this.state.divinationData = [];
            const originalYaoValues = [];
            for (let i = 0; i < 6; i++) {
                let sticks = 49;
                const changes = [];
                for (let j = 0; j < 3; j++) {
                    const randomRatio = 0.3 + Math.random() * 0.4;
                    const changeResult = this.performChangeWithInteraction(sticks, randomRatio);
                    sticks = changeResult.remaining;
                    changes.push(changeResult);
                }
                const yaoValue = sticks / 4;
                originalYaoValues.push(yaoValue);
                this.state.divinationData.push({ value: yaoValue, changes: changes, info: this.getYaoInfo(yaoValue) });
            }
            return originalYaoValues;
        },

        startDivination: async function() {
            if (this.state.isMobile && typeof DeviceOrientationEvent.requestPermission === 'function') {
                try { await DeviceOrientationEvent.requestPermission(); } catch (error) { console.error('ÈôÄËû∫‰ª™ÊùÉÈôêËØ∑Ê±ÇÂ§±Ë¥•:', error); }
            }
            this.elements.divineButton.disabled = true;
            this.elements.divineButton.innerHTML = 'Êé®Êºî‰∏≠...<span class="loader"></span>';
            this.elements.resultContainer.style.display = 'none';
            this.elements.originalHexagram.innerHTML = '';
            this.elements.changedHexagram.innerHTML = '';

            // [MODIFIED] Â¶ÇÊûúÊòØÂ§ßË°çÁ≠ÆÊ≥ïÔºåÂàôÊöÇÂÅúËßÜÂ∑ÆÊïàÊûúÂπ∂ÈáçÁΩÆÁ™óÂè£‰ΩçÁΩÆ
            if (this.state.divinationMethod === 'yarrow') {
                this.state.isParallaxActive = false;
                gsap.to(this.elements.mainContainer, { duration: 0.5, rotationY: 0, rotationX: 0, ease: "power1.out" });
            }

            gsap.to(this.elements.mainContainer, { opacity: 0, duration: 0.5 });
            document.body.classList.add('divining');
            let originalYaoValues;
            if (this.state.divinationMethod === 'yarrow') {
                originalYaoValues = await this.runYarrowDivination();
            } else {
                originalYaoValues = await this.runRandomDivination();
            }

            // [MODIFIED] Êé®ÊºîÁªìÊùüÂêéÔºåÈáçÊñ∞ÊøÄÊ¥ªËßÜÂ∑ÆÊïàÊûú
            this.state.isParallaxActive = true;
            this.state.isCalibrated = false; // Âº∫Âà∂ÈáçÊñ∞Ê†°ÂáÜÈôÄËû∫‰ª™Âü∫ÂáÜÔºå‰ª•Ëé∑ÂæóÂπ≥ÊªëÁöÑËøáÊ∏°

            document.body.classList.remove('divining');
            this.displayHexagrams(originalYaoValues);
            this.displayInterpretations(originalYaoValues);
            this.elements.introSection.style.display = 'none';
            this.elements.divineButton.parentElement.style.display = 'none';
            this.elements.resultContainer.style.display = 'block';
            gsap.to(this.elements.mainContainer, { opacity: 1, duration: 0.5 });
            this.setupResultActions();
        },

        setupResultActions: function() {
            this.elements.resultActionsWrapper.innerHTML = '';
            const interpButton = document.createElement('button');
            interpButton.id = 'interp-button';
            interpButton.textContent = 'Âç¶Ë±°Ëß£Èáä';
            interpButton.addEventListener('click', (e) => {
                this.addGlowEffect(e.currentTarget);
                this.showInterpretationModal();
            });
            this.elements.resultActionsWrapper.appendChild(interpButton);
            const resetButton = document.createElement('button');
            resetButton.id = 'reset-button';
            resetButton.textContent = 'ÂÜçÁÆó‰∏ÄÂç¶';
            resetButton.addEventListener('click', (e) => {
                this.addGlowEffect(e.currentTarget);
                this.elements.resultContainer.style.display = 'none';
                this.elements.introSection.style.display = 'block';
                this.elements.divineButton.parentElement.style.display = 'flex';
                this.elements.divineButton.innerHTML = 'ÂºÄÂßãÂçúÂç¶';
                this.elements.divineButton.disabled = false;
                this.state.isCalibrated = false;
            });
            this.elements.resultActionsWrapper.appendChild(resetButton);
        },

        showInterpretationModal: function() {
            // ÊöÇÂÅúËßÜÂ∑ÆÊïàÊûú
            this.state.isParallaxActive = false;
            gsap.to(this.elements.mainContainer, { duration: 0.5, rotationY: 0, rotationX: 0, ease: "power1.out" });

            const { currentOriginalHexKey, currentChangedHexKey } = this.state;
            const originalData = HEXAGRAM_DATA[currentOriginalHexKey];
            const changedData = currentChangedHexKey ? HEXAGRAM_DATA[currentChangedHexKey] : null;

            if (!originalData) return;

            const tabOriginal = document.getElementById('tab-original');
            const tabChanged = document.getElementById('tab-changed');
            const contentOriginal = document.getElementById('content-original');
            const contentChanged = document.getElementById('content-changed');

            contentOriginal.innerHTML = originalData.interpretation;
            tabOriginal.textContent = `Êú¨Âç¶Ôºö${originalData.name}`;

            if (changedData) {
                contentChanged.innerHTML = changedData.interpretation;
                tabChanged.textContent = `ÂèòÂç¶Ôºö${changedData.name}`;
                tabChanged.style.display = 'inline-block';
            } else {
                tabChanged.style.display = 'none';
            }

            tabOriginal.classList.add('active');
            contentOriginal.classList.add('active');
            tabChanged.classList.remove('active');
            contentChanged.classList.remove('active');

            this.elements.interpretationModalOverlay.classList.add('visible');
        },

        getYaoInfo: function(value) {
             switch (value) {
                case 6: return { type: 'yin', isChanging: true, binary: '0', symbol: '√ó' };
                case 7: return { type: 'yang', isChanging: false, binary: '1', symbol: '' };
                case 8: return { type: 'yin', isChanging: false, binary: '0', symbol: '' };
                case 9: return { type: 'yang', isChanging: true, binary: '1', symbol: '√ó' };
                default: return { type: 'error', isChanging: false, binary: '', symbol: '' };
            }
        },
        
        getChangedYaoValue: function(value) {
            if (value === 6) return 7;
            if (value === 9) return 8;
            return value;
        },

        createYaoElement: function(info) {
            const yaoDiv = document.createElement('div');
            yaoDiv.className = `yao yao-${info.type}`;
            if(info.type === 'placeholder') return yaoDiv;
            const svgNS = "http://www.w3.org/2000/svg";
            const svg = document.createElementNS(svgNS, "svg");
            svg.setAttribute("viewBox", "0 0 100 10"); 
            svg.setAttribute("preserveAspectRatio", "none");
            if (info.type === 'yang') {
                const line = document.createElementNS(svgNS, "line");
                line.setAttribute("x1", "0"); line.setAttribute("y1", "5"); line.setAttribute("x2", "100"); line.setAttribute("y2", "5");
                line.setAttribute("stroke-width", "10");
                svg.appendChild(line);
            } else if (info.type === 'yin') {
                const line1 = document.createElementNS(svgNS, "line");
                line1.setAttribute("x1", "0"); line1.setAttribute("y1", "5"); line1.setAttribute("x2", "40"); line1.setAttribute("y2", "5");
                line1.setAttribute("stroke-width", "10");
                svg.appendChild(line1);
                const line2 = document.createElementNS(svgNS, "line");
                line2.setAttribute("x1", "60"); line2.setAttribute("y1", "5"); line2.setAttribute("x2", "100"); line2.setAttribute("y2", "5");
                line2.setAttribute("stroke-width", "10");
                svg.appendChild(line2);
            }
            yaoDiv.appendChild(svg);
            if (info.isChanging) {
                yaoDiv.classList.add('yao-changing');
                const symbol = document.createElement('div');
                symbol.className = 'yao-changing-symbol';
                symbol.textContent = info.symbol;
                yaoDiv.appendChild(symbol);
            }
            return yaoDiv;
        },

        displayHexagrams: function(originalYaoValues) {
            this.elements.originalHexagram.innerHTML = '';
            this.elements.changedHexagram.innerHTML = '';
            originalYaoValues.forEach(value => {
                this.elements.originalHexagram.appendChild(this.createYaoElement(this.getYaoInfo(value)));
                this.elements.changedHexagram.appendChild(this.createYaoElement(this.getYaoInfo(this.getChangedYaoValue(value))));
            });
            gsap.from(this.elements.originalHexagram.children, { opacity: 0, stagger: 0.1 });
            gsap.from(this.elements.changedHexagram.children, { opacity: 0, stagger: 0.1 });
        },

        displayInterpretations: function(originalYaoValues) {
            const originalBinary = [...originalYaoValues].map(v => this.getYaoInfo(v).binary).reverse().join('');
            const changedBinary = [...originalYaoValues].map(v => this.getYaoInfo(this.getChangedYaoValue(v)).binary).reverse().join('');
            
            this.state.currentOriginalHexKey = originalBinary;
            this.state.currentChangedHexKey = originalBinary !== changedBinary ? changedBinary : null;

            const originalHexData = HEXAGRAM_DATA[originalBinary] || { name: 'Êú™Áü•' };
            const changedHexData = HEXAGRAM_DATA[changedBinary] || { name: 'Êú™Áü•' };
            this.elements.originalHexagramName.textContent = `${originalHexData.name}Âç¶`;
            gsap.from(this.elements.originalHexagramName, { opacity: 0, y: 10, duration: 0.5, ease: 'power1.out' });
            if (originalBinary !== changedBinary) {
                this.elements.changedHexagramContainer.style.display = 'flex';
                this.elements.changedHexagramName.textContent = `${changedHexData.name}Âç¶`;
                gsap.from(this.elements.changedHexagramName, { opacity: 0, y: 10, duration: 0.5, ease: 'power1.out' });
            } else {
                this.elements.changedHexagramContainer.style.display = 'none';
                this.elements.changedHexagramName.textContent = '';
            }
            
            // ‰øùÂ≠òÂçúÂç¶ÂéÜÂè≤ËÆ∞ÂΩï
            this.saveHistory(
                this.state.currentQuestion,
                originalBinary,
                originalBinary !== changedBinary ? changedBinary : null
            );
        },

        initParallax: function() {
            const container = this.elements.mainContainer;
            const sensitivity = 25;
            if (this.state.isMobile) {
                window.addEventListener('deviceorientation', (e) => {
                    // [MODIFIED] Â¶ÇÊûúËßÜÂ∑ÆÊïàÊûúÊöÇÂÅúÔºåÂàô‰∏çÊâßË°å‰ªª‰ΩïÊìç‰Ωú
                    if (!this.state.isParallaxActive) return;

                    const { beta, gamma } = e;
                    if (beta === null || gamma === null) return;
                    if (!this.state.isCalibrated) {
                        this.state.baseBeta = beta;
                        this.state.baseGamma = gamma;
                        this.state.isCalibrated = true;
                    }
                    const deltaBeta = beta - this.state.baseBeta;
                    const deltaGamma = gamma - this.state.baseGamma;
                    const yOffset = gsap.utils.clamp(-45, 45, deltaBeta) / 45; 
                    const xOffset = gsap.utils.clamp(-45, 45, deltaGamma) / 45;
                    gsap.to(container, { duration: 0.5, rotationY: xOffset * sensitivity, rotationX: -yOffset * sensitivity, ease: "power1.out" });
                });
            } else {
                window.addEventListener('mousemove', (e) => {
                    if (!this.state.isParallaxActive) return;

                    const { clientX, clientY } = e;
                    const { innerWidth, innerHeight } = window;
                    const xOffset = (clientX / innerWidth - 0.5) * 2;
                    const yOffset = (clientY / innerHeight - 0.5) * 2;
                    gsap.to(container, { duration: 0.8, rotationY: xOffset * 7, rotationX: -yOffset * 7, ease: "power1.out" });
                });
            }
        },

        addGlowEffect: function(button) {
            const glow = document.createElement('div');
            glow.className = 'button-glow-effect';
            button.appendChild(glow);
            setTimeout(() => glow.remove(), 600);
        },

        // ‰øùÂ≠òÂçúÂç¶ÂéÜÂè≤ËÆ∞ÂΩï
        saveHistory: function(question, originalHexKey, changedHexKey) {
            const historyItem = {
                date: new Date().toLocaleString(),
                question: question || 'Êó†ÈóÆÈ¢ò',
                originalHexKey: originalHexKey,
                changedHexKey: changedHexKey,
                originalName: HEXAGRAM_DATA[originalHexKey]?.name || 'Êú™Áü•',
                changedName: changedHexKey ? (HEXAGRAM_DATA[changedHexKey]?.name || 'Êú™Áü•') : null
            };
            
            // ‰ªéÊú¨Âú∞Â≠òÂÇ®Ëé∑ÂèñÂéÜÂè≤ËÆ∞ÂΩï
            let history = JSON.parse(localStorage.getItem('bagua-history') || '[]');
            
            // Ê∑ªÂä†Êñ∞ËÆ∞ÂΩïÂà∞ÂºÄÂ§¥
            history.unshift(historyItem);
            
            // ÈôêÂà∂ÂéÜÂè≤ËÆ∞ÂΩïÊï∞Èáè‰∏∫20Êù°
            if (history.length > 20) {
                history = history.slice(0, 20);
            }
            
            // ‰øùÂ≠òÂà∞Êú¨Âú∞Â≠òÂÇ®
            localStorage.setItem('bagua-history', JSON.stringify(history));
            
            // Êõ¥Êñ∞ÂΩìÂâçÁä∂ÊÄÅ
            this.state.divinationHistory = history;
        },
        
        // ÊòæÁ§∫ÂéÜÂè≤ËÆ∞ÂΩï
        showHistoryModal: function() {
            const historyContent = document.getElementById('history-content');
            historyContent.innerHTML = '';
            
            // ‰ªéÊú¨Âú∞Â≠òÂÇ®Ëé∑ÂèñÂéÜÂè≤ËÆ∞ÂΩï
            const history = JSON.parse(localStorage.getItem('bagua-history') || '[]');
            this.state.divinationHistory = history;
            
            if (history.length === 0) {
                historyContent.innerHTML = '<div class="no-history">ÊöÇÊó†ÂçúÂç¶ÂéÜÂè≤ËÆ∞ÂΩï</div>';
            } else {
                history.forEach((item, index) => {
                    const historyItem = document.createElement('div');
                    historyItem.className = 'history-item';
                    historyItem.dataset.index = index;
                    
                    const dateEl = document.createElement('div');
                    dateEl.className = 'history-date';
                    dateEl.textContent = item.date;
                    
                    const questionEl = document.createElement('div');
                    questionEl.className = 'history-question';
                    questionEl.textContent = item.question;
                    
                    const hexagramsEl = document.createElement('div');
                    hexagramsEl.className = 'history-hexagrams';
                    
                    const originalEl = document.createElement('div');
                    originalEl.className = 'history-hexagram';
                    originalEl.innerHTML = `<div class="history-hexagram-name">${item.originalName}Âç¶</div>`;
                    
                    hexagramsEl.appendChild(originalEl);
                    
                    if (item.changedName) {
                        const changedEl = document.createElement('div');
                        changedEl.className = 'history-hexagram';
                        changedEl.innerHTML = `<div class="history-hexagram-name">${item.changedName}Âç¶</div>`;
                        hexagramsEl.appendChild(changedEl);
                    }
                    
                    historyItem.appendChild(dateEl);
                    historyItem.appendChild(questionEl);
                    historyItem.appendChild(hexagramsEl);
                    
                    // ÁÇπÂáªÂéÜÂè≤ËÆ∞ÂΩïÈ°πÊü•ÁúãËØ¶ÊÉÖ
                    historyItem.addEventListener('click', () => {
                        document.getElementById('history-modal-overlay').classList.remove('visible');
                        this.showHistoryDetail(item);
                    });
                    
                    historyContent.appendChild(historyItem);
                });
            }
            
            document.getElementById('history-modal-overlay').classList.add('visible');
        },
        
        // ÊòæÁ§∫ÂéÜÂè≤ËÆ∞ÂΩïËØ¶ÊÉÖ
        showHistoryDetail: function(item) {
            // ÊòæÁ§∫Ëß£ÈáäÂºπÁ™ó
            const tabOriginal = document.getElementById('tab-original');
            const tabChanged = document.getElementById('tab-changed');
            const contentOriginal = document.getElementById('content-original');
            const contentChanged = document.getElementById('content-changed');
            
            const originalData = HEXAGRAM_DATA[item.originalHexKey];
            const changedData = item.changedHexKey ? HEXAGRAM_DATA[item.changedHexKey] : null;
            
            if (!originalData) return;
            
            contentOriginal.innerHTML = originalData.interpretation;
            tabOriginal.textContent = `Êú¨Âç¶Ôºö${originalData.name}`;
            
            if (changedData) {
                contentChanged.innerHTML = changedData.interpretation;
                tabChanged.textContent = `ÂèòÂç¶Ôºö${changedData.name}`;
                tabChanged.style.display = 'inline-block';
            } else {
                tabChanged.style.display = 'none';
            }
            
            tabOriginal.classList.add('active');
            contentOriginal.classList.add('active');
            tabChanged.classList.remove('active');
            contentChanged.classList.remove('active');
            
            this.elements.interpretationModalOverlay.classList.add('visible');
        },
        
        init: function() {
            // Âä†ËΩΩÂéÜÂè≤ËÆ∞ÂΩï
            this.state.divinationHistory = JSON.parse(localStorage.getItem('bagua-history') || '[]');
            
            this.elements.methodToggle.addEventListener('change', (e) => {
                this.state.divinationMethod = e.target.checked ? 'yarrow' : 'random';
                this.elements.labelYarrow.style.opacity = e.target.checked ? 1 : 0.7;
                this.elements.labelRandom.style.opacity = e.target.checked ? 0.7 : 1;
            });

            this.elements.divineButton.addEventListener('click', (e) => {
                this.addGlowEffect(e.currentTarget);
                // Ëé∑ÂèñÈóÆÈ¢òËæìÂÖ•
                const questionInput = document.getElementById('question-input');
                this.state.currentQuestion = questionInput.value.trim();
                this.startDivination();
            });
            
            // ÂéÜÂè≤ËÆ∞ÂΩïÊåâÈíÆ‰∫ã‰ª∂
            document.getElementById('history-button').addEventListener('click', () => {
                this.showHistoryModal();
            });
            
            // ÂéÜÂè≤ËÆ∞ÂΩïÊ®°ÊÄÅÊ°ÜÂÖ≥Èó≠ÊåâÈíÆ
            document.getElementById('history-close-btn').addEventListener('click', () => {
                document.getElementById('history-modal-overlay').classList.remove('visible');
            });
            
            // ÁÇπÂáªÂéÜÂè≤ËÆ∞ÂΩïÊ®°ÊÄÅÊ°ÜËÉåÊôØÂÖ≥Èó≠
            document.getElementById('history-modal-overlay').addEventListener('click', (e) => {
                if (e.target === document.getElementById('history-modal-overlay')) {
                    document.getElementById('history-modal-overlay').classList.remove('visible');
                }
            });

            // ÂºπÁ™ó‰∫ã‰ª∂ÁõëÂê¨
            this.elements.interpretationModalOverlay.addEventListener('click', (e) => {
                if (e.target === this.elements.interpretationModalOverlay) {
                    this.elements.interpretationModalOverlay.classList.remove('visible');
                    // ÊÅ¢Â§çËßÜÂ∑ÆÊïàÊûú
                    this.state.isParallaxActive = true;
                    this.state.isCalibrated = false; // ÈáçÊñ∞Ê†°ÂáÜÈôÄËû∫‰ª™Âü∫ÂáÜ
                }
            });
            document.getElementById('modal-close-btn').addEventListener('click', () => {
                this.elements.interpretationModalOverlay.classList.remove('visible');
                // ÊÅ¢Â§çËßÜÂ∑ÆÊïàÊûú
                this.state.isParallaxActive = true;
                this.state.isCalibrated = false; // ÈáçÊñ∞Ê†°ÂáÜÈôÄËû∫‰ª™Âü∫ÂáÜ
            });
            document.getElementById('tab-original').addEventListener('click', () => {
                document.getElementById('tab-original').classList.add('active');
                document.getElementById('content-original').classList.add('active');
                document.getElementById('tab-changed').classList.remove('active');
                document.getElementById('content-changed').classList.remove('active');
            });
            document.getElementById('tab-changed').addEventListener('click', () => {
                document.getElementById('tab-original').classList.remove('active');
                document.getElementById('content-original').classList.remove('active');
                document.getElementById('tab-changed').classList.add('active');
                document.getElementById('content-changed').classList.add('active');
            });

            this.initParallax();
        }
    };

    window.onload = () => {
        // ÈöêËóèÂä†ËΩΩÂä®Áîª
        setTimeout(() => {
            const pageLoader = document.getElementById('page-loader');
            if (pageLoader) {
                pageLoader.style.opacity = '0';
                setTimeout(() => {
                    pageLoader.style.visibility = 'hidden';
                }, 500);
            }
        }, 800);
        
        // Á°Æ‰øùÂú® data.js Âä†ËΩΩÂÆåÊØïÂêéÂàùÂßãÂåñ
        if (typeof HEXAGRAM_DATA !== 'undefined') {
            app.init();
        } else {
            // Â¶ÇÊûú data.js Âª∂ËøüÂä†ËΩΩÔºåËÆæÁΩÆ‰∏Ä‰∏™Áü≠Âª∂Êó∂
            setTimeout(() => app.init(), 100);
        }
        gsap.globalTimeline.timeScale(2.2);
        
        // ÂàùÂßãÂåñ‰∏ªÈ¢ò
        initTheme();
    };
    
    // ‰∏ªÈ¢òÂàáÊç¢ÂäüËÉΩ
    function initTheme() {
        const themeToggle = document.getElementById('theme-toggle');
        const savedTheme = localStorage.getItem('bagua-theme');
        
        // Â∫îÁî®‰øùÂ≠òÁöÑ‰∏ªÈ¢ò
        if (savedTheme === 'light') {
            document.documentElement.classList.add('light-theme');
        }
        
        themeToggle.addEventListener('click', () => {
            document.documentElement.classList.toggle('light-theme');
            const currentTheme = document.documentElement.classList.contains('light-theme') ? 'light' : 'dark';
            localStorage.setItem('bagua-theme', currentTheme);
        });
    }
    </script>
</body>
</html>
