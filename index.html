<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>在线卜卦 (Canvas 优化版)</title>
    
    <!-- 引入 GSAP 动画库 -->
    <script src="https://cdn.jsdelivr.net/npm/gsap@3.12.5/dist/gsap.min.js"></script>
    <!-- 引入分离出的卦象数据 -->
    <script src="data.js" defer></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;700&display=swap');

        :root {
            --bg-color: #1a1a1a;
            --container-bg: rgba(44, 44, 44, 0.15);
            --primary-text: #e0e0e0;
            --title-color: #d4af37;
            --border-color: #444;
            --button-bg: #8c735b;
            --button-hover-bg: #a0856a;
            --hexagram-bg: #333;
            --changing-yao-color: #ff5555;
            --glow-color: rgba(212, 175, 55, 0.7);
            --original-hex-color: #61afef;
            --changed-hex-color: #e06c75;
            --stalk-color: #f0e68c; /* 蓍草颜色 */
        }

        body {
            font-family: 'Noto Serif SC', serif;
            background-color: var(--bg-color);
            color: var(--primary-text);
            margin: 0;
            padding: 10px;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            -webkit-tap-highlight-color: transparent;
            transition: background-color 0.5s ease;
            overflow: hidden;
            perspective: 1000px;
        }

        #background-bagua {
            position: fixed;
            top: 50%;
            left: 50%;
            width: 65vmax;
            height: 65vmax;
            transform: translate(-50%, -50%);
            z-index: -1;
            opacity: 0.08;
            animation: slow-rotate 120s linear infinite;
        }

        @keyframes slow-rotate {
            from { transform: translate(-50%, -50%) rotate(0deg); }
            to { transform: translate(-50%, -50%) rotate(360deg); }
        }

        body.divining {
            background-color: #000;
        }
        body.divining::before {
            content: '';
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: radial-gradient(circle at center, transparent 40%, #000 85%);
            z-index: 99;
            pointer-events: none;
            opacity: 0;
            animation: fadeInVignette 1s ease forwards;
        }

        @keyframes fadeInVignette { to { opacity: 1; } }

        .container {
            max-width: 800px; width: 95%; margin: auto; padding: 30px;
            background-color: var(--container-bg);
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
            border: 1px solid var(--border-color);
            box-sizing: border-box;
            transition: opacity 0.5s ease, transform 0.2s ease-out;
            opacity: 0;
            animation: fadeInContainer 1s 0.2s ease forwards;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            transform-style: preserve-3d;
            max-height: 95vh;
            overflow-y: auto;
        }

        @keyframes fadeInContainer { to { opacity: 1; } }

        h1, h2, h3 { color: var(--title-color); text-align: center; font-weight: 700; }
        h1 { font-size: 2.2em; margin-bottom: 25px; }
        h2 { border-bottom: 1px solid var(--border-color); padding-bottom: 15px; margin-top: 40px; margin-bottom: 20px; }
        .section p { text-align: center; line-height: 1.8; font-size: 1.1em; margin-bottom: 20px; }
        
        .method-selector {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 25px;
        }
        .method-selector label {
            margin: 0 10px;
            font-size: 1.1em;
            color: var(--primary-text);
            opacity: 0.7;
            transition: opacity 0.3s ease;
        }
        .method-switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
        }
        .method-switch input { display: none; }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: #444;
            transition: .4s;
            border-radius: 34px;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 26px; width: 26px;
            left: 4px; bottom: 4px;
            background-color: var(--button-bg);
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .slider { background-color: var(--title-color); }
        input:checked + .slider:before { transform: translateX(26px); }
        #label-yarrow { opacity: 1; }

        .button-wrapper { text-align: center; margin-top: 20px; position: relative; min-height: 60px; display: flex; justify-content: center; align-items: center; gap: 15px;}
        button {
            font-family: inherit; font-size: 1.2em; padding: 12px 25px; background-color: var(--button-bg);
            color: white; border: none; border-radius: 8px; cursor: pointer; transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            position: relative;
            overflow: hidden;
        }
        button:hover:not(:disabled) { 
            background-color: var(--button-hover-bg); 
            transform: translateY(-2px); 
            box-shadow: 0 6px 20px var(--glow-color); 
        }
        button:active:not(:disabled) { transform: translateY(0); box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
        button:disabled { background-color: #555; color: #888; cursor: not-allowed; }

        #interp-button {
            background-color: #c93756; /* 朱红色 */
        }
        #interp-button:hover:not(:disabled) {
            background-color: #e04a69; /* 悬停时更亮的朱红色 */
        }

        .button-glow-effect {
            position: absolute; top: 50%; left: 50%; width: 10px; height: 10px;
            background: var(--title-color); border-radius: 50%;
            transform: translate(-50%, -50%) scale(0); opacity: 0.7;
            animation: button-glow 0.6s ease-out;
        }
        @keyframes button-glow { to { transform: translate(-50%, -50%) scale(20); opacity: 0; } }

        .loader {
            width: 18px; height: 18px; border: 2px solid #FFF; border-bottom-color: transparent;
            border-radius: 50%; display: inline-block; box-sizing: border-box;
            animation: rotation 1s linear infinite; margin-left: 10px; vertical-align: middle;
        }
        @keyframes rotation { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        #interactive-animation-container {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85);
            z-index: 100;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            opacity: 0; pointer-events: none; transition: opacity 0.5s ease;
        }
        #interactive-animation-container.visible { opacity: 1; pointer-events: all; }
        #interaction-prompt { color: var(--title-color); font-size: 1.5em; margin-bottom: 20px; text-shadow: 0 0 10px var(--glow-color); min-height: 1.5em;}
        
        #canvas-wrapper {
            width: 80%; max-width: 500px; height: 150px;
            cursor: pointer; border: 2px dashed var(--border-color); border-radius: 10px;
            position: relative;
        }
        #stalk-canvas {
            position: fixed; /* MODIFICATION: Changed to fixed for viewport positioning */
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            pointer-events: none; 
        }

        #yao-stats-container {
            position: fixed;
            bottom: 40px;
            left: 50%;
            transform: translateX(-50%);
            width: 90%;
            max-width: 400px;
            background: rgba(0, 0, 0, 0.75);
            border-radius: 8px;
            border: 1px solid var(--border-color);
            opacity: 0;
            color: var(--primary-text);
            cursor: pointer;
            transition: max-height 0.4s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.3s ease;
            overflow: hidden;
        }

        #yao-stats-container.collapsed {
            max-height: 50px;
        }

        #yao-stats-container:not(.collapsed) {
            max-height: 500px; 
        }

        .yao-stats-title { 
            padding: 12px;
            box-sizing: border-box;
            width: 100%;
            justify-content: center;
            font-size: 1em; 
            color: var(--title-color); 
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .yao-stats-title::before {
            content: '▲';
            font-size: 0.8em;
            transition: transform 0.4s ease;
        }
        #yao-stats-container.collapsed .yao-stats-title::before {
            transform: rotate(180deg);
        }
        .yao-stats-content {
            padding: 0 15px 15px;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            width: 100%;
            transition: opacity 0.2s ease;
        }
        #yao-stats-container.collapsed .yao-stats-content {
            opacity: 0;
            pointer-events: none;
        }

        .yao-stats-changes { display: flex; justify-content: center; gap: 10px; width: 100%; }
        .change-stat { background: rgba(255,255,255,0.1); padding: 5px 8px; border-radius: 4px; font-size: 0.8em; text-align: center; }
        .change-stat .label { font-size: 0.9em; opacity: 0.7; }
        .change-stat .value { font-weight: bold; margin-top: 2px; }
        .yao-stats-result { font-size: 1.1em; font-weight: bold; margin-top: 5px; background: var(--button-bg); padding: 4px 12px; border-radius: 5px; }

        #result-container { display: none; margin-top: 30px; }
        .hexagram-display { display: flex; justify-content: space-around; margin-top: 20px; padding: 20px; background-color: var(--hexagram-bg); border-radius: 8px; border: 1px solid var(--border-color); }
        .hexagram { display: flex; flex-direction: column; align-items: center; text-align: center; }
        .hexagram h3 { font-size: 1.5em; margin-bottom: 15px; }
        .yao-lines { display: flex; flex-direction: column-reverse; }
        .hexagram-name { margin-top: 15px; font-size: 1.8em; font-weight: bold; height: 1.5em; letter-spacing: 2px; text-shadow: 0 0 8px rgba(0,0,0,0.5); }
        #original-hexagram-name { color: var(--original-hex-color); }
        #changed-hexagram-name { color: var(--changed-hex-color); }
        .yao { display: flex; justify-content: center; align-items: center; height: 25px; margin: 8px 0; position: relative; width: 120px; }
        .yao svg { width: 100%; height: 8px; display: block; }
        .yao svg line { stroke: var(--primary-text); transition: stroke 0.3s ease; }
        .yao.yao-changing svg line { stroke: var(--changing-yao-color); }
        .yao-changing-symbol { position: absolute; right: -25px; top: 50%; transform: translateY(-50%); font-size: 1.2em; color: var(--changing-yao-color); font-weight: bold; }
        
        #interpretation-modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); 
            backdrop-filter: blur(5px);
            z-index: 200; display: flex; justify-content: center; align-items: center;
            opacity: 0; pointer-events: none; transition: opacity 0.3s ease;
        }
        #interpretation-modal-overlay.visible { opacity: 1; pointer-events: all; }
        #interpretation-modal {
            width: 90%; max-width: 600px; background: var(--container-bg);
            border-radius: 10px; border: 1px solid var(--border-color);
            box-shadow: 0 10px 40px rgba(0,0,0,0.5); display: flex; flex-direction: column;
            max-height: 80vh; transform: scale(0.9); transition: transform 0.3s ease;
        }
        #interpretation-modal-overlay.visible #interpretation-modal { transform: scale(1); }
        #modal-header { display: flex; justify-content: space-between; align-items: center; padding: 10px 20px; border-bottom: 1px solid var(--border-color); flex-shrink: 0; }
        #modal-tabs { display: flex; gap: 10px; }
        .modal-tab {
            background: transparent; border: 2px solid transparent; color: var(--primary-text);
            opacity: 0.6; padding: 8px 16px; font-size: 1em; border-radius: 6px;
            cursor: pointer; transition: all 0.3s ease;
        }
        .modal-tab.active { opacity: 1; color: var(--title-color); border-bottom-color: var(--title-color); }
        #modal-close-btn { background: none; border: none; color: var(--primary-text); font-size: 2.5em; cursor: pointer; opacity: 0.7; transition: opacity 0.2s; padding: 0; line-height: 1; }
        #modal-close-btn:hover { opacity: 1; }
        #modal-content { padding: 25px; overflow-y: auto; line-height: 1.9; font-size: 1.1em; white-space: pre-wrap; }
        .tab-content { display: none; }
        .tab-content.active { display: block; animation: contentFadeIn 0.5s ease; }
        @keyframes contentFadeIn { from { opacity: 0; } to { opacity: 1; } }

        #final-yao-animation-overlay {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            z-index: 999;
            display: flex;
            justify-content: center;
            align-items: center;
            pointer-events: none;
            opacity: 0;
            background: rgba(0,0,0,0.7);
        }
        #final-yao-lines {
            display: flex;
            flex-direction: column-reverse;
        }
        #final-yao-lines .yao {
            width: 200px;
            height: 35px;
            margin: 12px 0;
        }

        @media (max-width: 768px) {
            body { align-items: center; padding: 0; }
            .container { padding: 15px; margin: 0 2.5%; width: 95%; border-radius: 8px; overflow: auto; }
            h1 { font-size: 1.5em; }
            .hexagram-display { flex-direction: row; justify-content: space-around; align-items: flex-start; padding: 10px 5px; }
            .hexagram { flex: 1; min-width: 0; padding: 0 5px; }
            .hexagram h3 { font-size: 1em; margin-bottom: 6px; }
            .hexagram-name { font-size: 1.1em; margin-top: 6px; word-break: break-all; }
            .yao { width: 100%; max-width: 200px; height: 14px; margin: 3px auto; }
            .yao svg { height: 3px; }
            .yao-changing-symbol { font-size: 0.8em; right: -16px;}
            #yao-stats-container { 
                padding: 8px; 
                gap: 5px; 
            }
            .change-stat { font-size: 0.7em; padding: 4px 6px; }
            .yao-stats-result { font-size: 1em; }
            button { font-size: 1em; padding: 10px 18px; }
            #final-yao-lines .yao {
                width: 150px;
                height: 25px;
                margin: 8px 0;
            }
        }
    </style>
</head>
<body>
    
    <div id="background-bagua">
        <svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg" fill="none" stroke="currentColor" color="var(--primary-text)">
            <defs>
                <g id="yang-line"><path d="M -4.5,0 L 4.5,0" stroke-width="1.5" stroke-linecap="butt"></path></g>
                <g id="yin-line"><path d="M -4.5,0 L -1.5,0 M 1.5,0 L 4.5,0" stroke-width="1.5" stroke-linecap="butt"></path></g>
            </defs>
            <g stroke-width="0.5">
                <circle cx="50" cy="50" r="48"></circle><circle cx="50" cy="50" r="44"></circle>
                <circle cx="50" cy="50" r="35"></circle><circle cx="50" cy="50" r="34"></circle>
                <circle cx="50" cy="50" r="26"></circle><circle cx="50" cy="50" r="25"></circle>
                <circle cx="50" cy="50" r="17"></circle><circle cx="50" cy="50" r="16"></circle>
            </g>
            <g stroke-width="0">
                <path d="M50 16 A 34 34 0 0 0 50 84 Z" fill="var(--bg-color)"></path>
                <path d="M50 16 A 34 34 0 0 1 50 84 Z" fill="currentColor"></path>
                <circle cx="50" cy="67" r="17" fill="currentColor"></circle>
                <circle cx="50" cy="33" r="17" fill="var(--bg-color)"></circle>
                <circle cx="50" cy="33" r="4" fill="currentColor"></circle>
                <circle cx="50" cy="67" r="4" fill="var(--bg-color)"></circle>
            </g>
            <g transform="translate(50 50)">
                 <g transform="translate(0, -39.5)"><use href="#yang-line" y="3"></use><use href="#yang-line" y="0"></use><use href="#yang-line" y="-3"></use></g>
                 <g transform="rotate(45) translate(0, -39.5)"><use href="#yin-line" y="3"></use><use href="#yang-line" y="0"></use><use href="#yang-line" y="-3"></use></g>
                 <g transform="rotate(90) translate(0, -39.5)"><use href="#yin-line" y="3"></use><use href="#yang-line" y="0"></use><use href="#yin-line" y="-3"></use></g>
                 <g transform="rotate(135) translate(0, -39.5)"><use href="#yin-line" y="3"></use><use href="#yin-line" y="0"></use><use href="#yang-line" y="-3"></use></g>
                 <g transform="rotate(180) translate(0, -39.5)"><use href="#yin-line" y="3"></use><use href="#yin-line" y="0"></use><use href="#yin-line" y="-3"></use></g>
                 <g transform="rotate(225) translate(0, -39.5)"><use href="#yang-line" y="3"></use><use href="#yin-line" y="0"></use><use href="#yin-line" y="-3"></use></g>
                 <g transform="rotate(270) translate(0, -39.5)"><use href="#yang-line" y="3"></use><use href="#yin-line" y="0"></use><use href="#yang-line" y="-3"></use></g>
                 <g transform="rotate(315) translate(0, -39.5)"><use href="#yang-line" y="3"></use><use href="#yang-line" y="0"></use><use href="#yin-line" y="-3"></use></g>
            </g>
        </svg>
    </div>

    <div class="container" id="main-container">
        <div id="intro-section">
            <h1>大衍筮法 在线卜卦</h1>
            <div class="section">
                <p>心诚则灵，一事一问</p>
            </div>
            <div class="method-selector">
                <label id="label-random">随机数法</label>
                <label class="method-switch">
                    <input type="checkbox" id="method-toggle" checked>
                    <span class="slider"></span>
                </label>
                <label id="label-yarrow">大衍筮法</label>
            </div>
        </div>
        
        <div class="button-wrapper">
            <button id="divine-button">开始卜卦</button>
        </div>

        <div id="result-container">
            <div class="hexagram-display">
                <div class="hexagram">
                    <h3>本卦</h3>
                    <div id="original-hexagram" class="yao-lines"></div>
                    <div id="original-hexagram-name" class="hexagram-name"></div>
                </div>
                <div class="hexagram" id="changed-hexagram-container">
                    <h3>变卦</h3>
                    <div id="changed-hexagram" class="yao-lines"></div>
                    <div id="changed-hexagram-name" class="hexagram-name"></div>
                </div>
            </div>
            <div id="result-actions-wrapper" class="button-wrapper"></div>
        </div>
    </div>
    
    <div id="interactive-animation-container">
        <div id="interaction-prompt"></div>
        <div id="canvas-wrapper">
        </div>
        <canvas id="stalk-canvas"></canvas>
        <div id="yao-stats-container" class="collapsed">
            <div class="yao-stats-title">本爻演算</div>
            <div class="yao-stats-content">
                <div id="yao-stats-changes" class="yao-stats-changes"></div>
                <div id="yao-stats-result" class="yao-stats-result"></div>
            </div>
        </div>
    </div>

    <div id="final-yao-animation-overlay">
        <div id="final-yao-lines"></div>
    </div>

    <div id="interpretation-modal-overlay">
        <div id="interpretation-modal">
            <div id="modal-header">
                <div id="modal-tabs">
                    <button id="tab-original" class="modal-tab active">本卦</button>
                    <button id="tab-changed" class="modal-tab">变卦</button>
                </div>
                <button id="modal-close-btn">&times;</button>
            </div>
            <div id="modal-content">
                <div id="content-original" class="tab-content active"></div>
                <div id="content-changed" class="tab-content"></div>
            </div>
        </div>
    </div>

    <script>
    // 注意: 卦象数据 HEXAGRAM_DATA 现在从 data.js 文件加载
    
    const app = {
        // 集中管理所有DOM元素的引用
        elements: {
            divineButton: document.getElementById('divine-button'),
            interactiveContainer: document.getElementById('interactive-animation-container'),
            interactionPrompt: document.getElementById('interaction-prompt'),
            canvasWrapper: document.getElementById('canvas-wrapper'),
            canvas: document.getElementById('stalk-canvas'),
            resultContainer: document.getElementById('result-container'),
            originalHexagram: document.getElementById('original-hexagram'),
            changedHexagram: document.getElementById('changed-hexagram'),
            originalHexagramName: document.getElementById('original-hexagram-name'),
            changedHexagramName: document.getElementById('changed-hexagram-name'),
            mainContainer: document.getElementById('main-container'),
            introSection: document.getElementById('intro-section'),
            changedHexagramContainer: document.getElementById('changed-hexagram-container'),
            methodToggle: document.getElementById('method-toggle'),
            labelYarrow: document.getElementById('label-yarrow'),
            labelRandom: document.getElementById('label-random'),
            yaoStatsContainer: document.getElementById('yao-stats-container'),
            yaoStatsChanges: document.getElementById('yao-stats-changes'),
            yaoStatsResult: document.getElementById('yao-stats-result'),
            resultActionsWrapper: document.getElementById('result-actions-wrapper'),
            interpretationModalOverlay: document.getElementById('interpretation-modal-overlay'),
            finalYaoAnimationOverlay: document.getElementById('final-yao-animation-overlay'),
            finalYaoLines: document.getElementById('final-yao-lines'),
        },
        
        // 存储应用的状态
        state: {
            divinationData: [],
            isMobile: /Mobi|Android/i.test(navigator.userAgent),
            divinationMethod: 'yarrow', // 默认为大衍筮法
            isCalibrated: false, // 用于陀螺仪校准
            baseBeta: 0,
            baseGamma: 0,
            currentOriginalHexKey: null,
            currentChangedHexKey: null,
            canvasContext: null,
            stalks: [], // 存储所有蓍草对象
            animationRunning: false, // 动画循环是否在运行
        },

        // --- Canvas 动画逻辑 ---

        // 初始化Canvas，设置高DPI显示
        setupCanvas: function() {
            this.state.canvasContext = this.elements.canvas.getContext('2d');
            const dpr = window.devicePixelRatio || 1;
            this.elements.canvas.width = window.innerWidth * dpr;
            this.elements.canvas.height = window.innerHeight * dpr;
            this.state.canvasContext.scale(dpr, dpr);
        },

        // 创建一个蓍草对象，用于Canvas渲染
        createStalk: function(x, y, rotation, width, height) {
            return { x, y, rotation, width, height, alpha: 1, scale: 1 };
        },

        // 绘制所有蓍草到Canvas上
        drawStalks: function() {
            if (!this.state.animationRunning) return;
            
            const ctx = this.state.canvasContext;
            ctx.clearRect(0, 0, window.innerWidth, window.innerHeight);
            ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--stalk-color');
            
            this.state.stalks.forEach(stalk => {
                ctx.save();
                ctx.globalAlpha = stalk.alpha;
                ctx.translate(stalk.x, stalk.y);
                ctx.rotate(stalk.rotation * Math.PI / 180);
                ctx.scale(stalk.scale, stalk.scale);
                ctx.fillRect(-stalk.width / 2, -stalk.height / 2, stalk.width, stalk.height);
                ctx.restore();
            });
        },

        // 启动GSAP的ticker来持续调用绘制函数，形成动画
        startAnimationLoop: function() {
            this.state.animationRunning = true;
            gsap.ticker.add(this.drawStalks.bind(this));
        },

        // 停止动画循环
        stopAnimationLoop: function() {
            this.state.animationRunning = false;
            gsap.ticker.remove(this.drawStalks.bind(this));
        },
        
        // --- 核心算法与交互 ---

        // 根据用户点击位置，执行一次“变”的操作
        performChangeWithInteraction: function(totalSticks, clickRatio) {
            if (totalSticks <= 1) return { total: totalSticks, left: totalSticks, right: 0, leftRem: totalSticks, rightRem: 0, removed: 0, remaining: totalSticks };
            let leftPile = Math.round(totalSticks * clickRatio);
            if (leftPile < 1) leftPile = 1;
            if (leftPile >= totalSticks) leftPile = totalSticks - 1;
            const rightPile = totalSticks - leftPile;
            const rightPileForCounting = rightPile - 1;
            let leftRemainder = leftPile % 4;
            if (leftRemainder === 0) leftRemainder = 4;
            let rightRemainder = rightPileForCounting % 4;
            if (rightRemainder === 0) rightRemainder = 4;
            const totalRemoved = 1 + leftRemainder + rightRemainder;
            const remainingSticks = totalSticks - totalRemoved;
            return { total: totalSticks, left: leftPile, right: rightPile, leftRem: leftRemainder, rightRem: rightRemainder, removed: totalRemoved, remaining: remainingSticks };
        },
        
        // 获取用户交互以完成一次“变”，并播放动画
        getChangeFromUser: function(totalSticks, changeName) {
            return new Promise(resolve => {
                this.elements.interactionPrompt.textContent = `第 ${changeName} 变，请点击分蓍草`;
                
                this.state.stalks = [];
                const boxRect = this.elements.canvasWrapper.getBoundingClientRect();
                const stalkWidth = 2;
                const stalkHeight = 100;

                for (let i = 0; i < totalSticks; i++) {
                    const stalk = this.createStalk(0, 0, 0, stalkWidth, stalkHeight);
                    this.state.stalks.push(stalk);
                }

                gsap.fromTo(this.state.stalks, 
                    { x: boxRect.left + boxRect.width / 2, y: boxRect.top + boxRect.height / 2, rotation: 0 }, 
                    { 
                        x: (i) => (boxRect.left + boxRect.width / 2) + (i - totalSticks / 2) * (boxRect.width * 0.8 / totalSticks),
                        y: () => boxRect.top + boxRect.height / 2 + (Math.random() - 0.5) * 10,
                        rotation: () => (Math.random() - 0.5) * 15,
                        duration: 0.5, 
                        ease: 'power2.out' 
                    }
                );
                
                const clickHandler = (e) => {
                    this.elements.canvasWrapper.removeEventListener('click', clickHandler);
                    this.elements.canvasWrapper.style.cursor = 'default';
                    
                    const rect = this.elements.canvasWrapper.getBoundingClientRect();
                    const clickX = e.clientX - rect.left;
                    const clickRatio = clickX / rect.width;
                    const changeResult = this.performChangeWithInteraction(totalSticks, clickRatio);
                    
                    this.elements.interactionPrompt.textContent = `天: ${changeResult.left}, 地: ${changeResult.right}`;

                    const tl = gsap.timeline({ onComplete: () => resolve(changeResult) });
                    const leftStalks = this.state.stalks.slice(0, changeResult.left);
                    const rightStalks = this.state.stalks.slice(changeResult.left);

                    tl.to(leftStalks, { x: '-=100', rotation: -20, duration: 0.3, ease: 'power2.inOut', stagger: 0.005 });
                    tl.to(rightStalks, { x: '+=100', rotation: 20, duration: 0.3, ease: 'power2.inOut', stagger: 0.005 }, '<');
                    
                    const heldStalk = rightStalks.pop();
                    tl.to(heldStalk, { y: '-=80', x: '+=20', rotation: 15, duration: 0.3, ease: 'power2.out' }, '-=0.2');
                    
                    const leftRemainderStalks = leftStalks.slice(0, changeResult.leftRem);
                    const rightRemainderStalks = rightStalks.slice(0, changeResult.rightRem);
                    
                    const nonRemainderLeft = leftStalks.filter(s => !leftRemainderStalks.includes(s));
                    const nonRemainderRight = rightStalks.filter(s => !rightRemainderStalks.includes(s));
                    
                    tl.to([...nonRemainderLeft, ...nonRemainderRight], { alpha: 0.3, duration: 0.2 }, '+=0.1');
                    tl.to(leftRemainderStalks, { x: '-=30', scale: 1.2, duration: 0.3, ease: 'power2.out' }, '<');
                    tl.to(rightRemainderStalks, { x: '+=30', scale: 1.2, duration: 0.3, ease: 'power2.out' }, '<');
                    
                    const allRemainders = [heldStalk, ...leftRemainderStalks, ...rightRemainderStalks];
                    const centerX = boxRect.left + boxRect.width / 2;
                    const centerY = boxRect.top + boxRect.height / 2;

                    tl.to(allRemainders, {
                        x: centerX,
                        y: centerY - 40,
                        rotation: () => (Math.random() - 0.5) * 30,
                        duration: 0.5,
                        ease: 'power2.out',
                        stagger: 0.02
                    }, "+=0.3");
                    
                    const statsRect = this.elements.yaoStatsContainer.getBoundingClientRect();
                    const targetX = statsRect.left + statsRect.width / 2;
                    const targetY = statsRect.top;

                    tl.to(allRemainders, {
                        x: targetX,
                        y: targetY,
                        alpha: 0,
                        scale: 0.2, 
                        duration: 0.8,
                        ease: 'power1.in',
                        stagger: {
                            amount: 0.25,
                            from: 'center'
                        }
                    });
                    
                    const remainingStalks = this.state.stalks.filter(s => !allRemainders.includes(s));
                    tl.to(remainingStalks, { x: centerX, y: centerY, rotation: 0, alpha: 1, duration: 0.4, ease: 'power2.inOut' }, '-=0.5');
                };
                this.elements.canvasWrapper.addEventListener('click', clickHandler);
                this.elements.canvasWrapper.style.cursor = 'pointer';
            });
        },

        // 通过三次“变”来生成一个爻
        generateYaoInteractively: async function() {
            let sticks = 49;
            const changes = [];
            
            this.elements.yaoStatsChanges.innerHTML = '';
            this.elements.yaoStatsResult.innerHTML = '';
            this.elements.yaoStatsContainer.classList.add('collapsed');
            gsap.to(this.elements.yaoStatsContainer, { opacity: 1, duration: 0.3 });

            for (let i = 0; i < 3; i++) {
                const changeNames = ['一', '二', '三'];
                const changeResult = await this.getChangeFromUser(sticks, changeNames[i]);
                sticks = changeResult.remaining;
                changes.push(changeResult);

                const changeStatEl = document.createElement('div');
                changeStatEl.className = 'change-stat';
                changeStatEl.innerHTML = `<div class="label">第${changeNames[i]}变</div><div class="value">余 ${changeResult.remaining}</div>`;
                this.elements.yaoStatsChanges.appendChild(changeStatEl);
                gsap.from(changeStatEl, { opacity: 0, scale: 0.5, duration: 0.4, ease: 'back.out' });
            }
            const yaoValue = sticks / 4;
            const yaoInfo = this.getYaoInfo(yaoValue);
            
            this.elements.yaoStatsResult.textContent = `本爻蓍草: ${yaoValue * 4} 根`;
            gsap.from(this.elements.yaoStatsResult, { opacity: 0, y: 10, duration: 0.4 });
            
            return { value: yaoValue, changes: changes, info: yaoInfo };
        },

        // 最后一个爻生成后的收尾动画
        animateFinalHexagramFormation: async function() {
            const tl = gsap.timeline();
            tl.to(this.elements.yaoStatsContainer, { opacity: 0, duration: 0.3 });
            tl.to(this.state.stalks, { 
                alpha: 0, 
                scale: 0, 
                duration: 0.8, 
                stagger: 0.02, 
                ease: 'power2.in' 
            }, "<");
            await new Promise(resolve => tl.eventCallback('onComplete', resolve));
        },

        // --- 卜卦流程控制 ---

        // 执行完整的大衍筮法流程
        runYarrowDivination: async function() {
            this.setupCanvas();
            this.startAnimationLoop();
            this.elements.interactiveContainer.classList.add('visible');
            // MODIFICATION: Wait for the container's fade-in animation to complete before calculating positions.
            await new Promise(resolve => setTimeout(resolve, 500));
            this.elements.yaoStatsContainer.style.opacity = 0;
            this.state.divinationData = [];
            const originalYaoValues = [];
            const yaoNames = ['初', '二', '三', '四', '五', '上'];
            for (let i = 0; i < 6; i++) {
                this.elements.interactionPrompt.textContent = `求 ${yaoNames[i]} 爻`;
                await new Promise(r => setTimeout(r, 150)); // Keep for pacing between yaos
                const yaoResult = await this.generateYaoInteractively();
                originalYaoValues.push(yaoResult.value);
                this.state.divinationData.push(yaoResult);
            }
            this.elements.interactionPrompt.textContent = '卦象生成...';
            await this.animateFinalHexagramFormation();
            this.elements.interactiveContainer.classList.remove('visible');
            this.stopAnimationLoop();
            return originalYaoValues;
        },

        // 执行随机数法流程
        runRandomDivination: async function() {
            this.state.divinationData = [];
            const originalYaoValues = [];
            for (let i = 0; i < 6; i++) {
                let sticks = 49;
                const changes = [];
                for (let j = 0; j < 3; j++) {
                    const randomRatio = 0.3 + Math.random() * 0.4;
                    const changeResult = this.performChangeWithInteraction(sticks, randomRatio);
                    sticks = changeResult.remaining;
                    changes.push(changeResult);
                }
                const yaoValue = sticks / 4;
                originalYaoValues.push(yaoValue);
                this.state.divinationData.push({ value: yaoValue, changes: changes, info: this.getYaoInfo(yaoValue) });
            }
            return originalYaoValues;
        },

        // 显示最终六爻的过渡动画
        showFinalYaoAnimation: function(yaoValues) {
            return new Promise(resolve => {
                const overlay = this.elements.finalYaoAnimationOverlay;
                const linesContainer = this.elements.finalYaoLines;
                linesContainer.innerHTML = ''; 

                gsap.set(overlay, { opacity: 0 });
                gsap.set(linesContainer, { scale: 1, opacity: 1 });

                yaoValues.forEach(value => {
                    const yaoInfo = this.getYaoInfo(value);
                    const displayInfo = { ...yaoInfo, isChanging: false, symbol: '' };
                    linesContainer.appendChild(this.createYaoElement(displayInfo));
                });

                const tl = gsap.timeline({ onComplete: resolve });

                tl.to(overlay, { opacity: 1, duration: 0.3 })
                  .from(linesContainer.children, {
                      opacity: 0,
                      scale: 0.5,
                      stagger: 0.1,
                      duration: 0.5,
                      ease: 'back.out(1.7)'
                  })
                  .to(linesContainer, {
                      scale: 0,
                      opacity: 0,
                      duration: 0.6,
                      ease: 'power2.in'
                  }, "+=1.2")
                  .to(overlay, {
                      opacity: 0,
                      duration: 0.6,
                      ease: 'power2.in'
                  }, "<"); 
            });
        },

        // 总的卜卦启动函数
        startDivination: async function() {
            if (this.state.isMobile && typeof DeviceOrientationEvent.requestPermission === 'function') {
                try { await DeviceOrientationEvent.requestPermission(); } catch (error) { console.error('陀螺仪权限请求失败:', error); }
            }
            this.elements.divineButton.disabled = true;
            this.elements.divineButton.innerHTML = '推演中...<span class="loader"></span>';
            this.elements.resultContainer.style.display = 'none';
            this.elements.originalHexagram.innerHTML = '';
            this.elements.changedHexagram.innerHTML = '';
            gsap.to(this.elements.mainContainer, { opacity: 0, duration: 0.5 });
            document.body.classList.add('divining');
            
            let originalYaoValues;
            if (this.state.divinationMethod === 'yarrow') {
                originalYaoValues = await this.runYarrowDivination();
            } else {
                originalYaoValues = await this.runRandomDivination();
            }

            await this.showFinalYaoAnimation(originalYaoValues);

            document.body.classList.remove('divining');
            this.displayHexagrams(originalYaoValues);
            this.displayInterpretations(originalYaoValues);
            this.elements.introSection.style.display = 'none';
            this.elements.divineButton.parentElement.style.display = 'none';
            this.elements.resultContainer.style.display = 'block';
            gsap.to(this.elements.mainContainer, { opacity: 1, duration: 0.5 });
            this.setupResultActions();
        },

        // --- UI 渲染与更新 ---

        // 设置结果页面的按钮（卦象解释、再算一卦）
        setupResultActions: function() {
            this.elements.resultActionsWrapper.innerHTML = '';
            const interpButton = document.createElement('button');
            interpButton.id = 'interp-button';
            interpButton.textContent = '卦象解释';
            interpButton.addEventListener('click', (e) => {
                this.addGlowEffect(e.currentTarget);
                this.showInterpretationModal();
            });
            this.elements.resultActionsWrapper.appendChild(interpButton);
            const resetButton = document.createElement('button');
            resetButton.id = 'reset-button';
            resetButton.textContent = '再算一卦';
            resetButton.addEventListener('click', (e) => {
                this.addGlowEffect(e.currentTarget);
                this.elements.resultContainer.style.display = 'none';
                this.elements.introSection.style.display = 'block';
                this.elements.divineButton.parentElement.style.display = 'flex';
                this.elements.divineButton.innerHTML = '开始卜卦';
                this.elements.divineButton.disabled = false;
                this.state.isCalibrated = false;
            });
            this.elements.resultActionsWrapper.appendChild(resetButton);
        },

        // 显示卦象解释的弹窗
        showInterpretationModal: function() {
            const { currentOriginalHexKey, currentChangedHexKey } = this.state;
            const originalData = HEXAGRAM_DATA[currentOriginalHexKey];
            const changedData = currentChangedHexKey ? HEXAGRAM_DATA[currentChangedHexKey] : null;

            if (!originalData) return;

            const tabOriginal = document.getElementById('tab-original');
            const tabChanged = document.getElementById('tab-changed');
            const contentOriginal = document.getElementById('content-original');
            const contentChanged = document.getElementById('content-changed');

            contentOriginal.innerHTML = originalData.interpretation;
            tabOriginal.textContent = `本卦：${originalData.name}`;

            if (changedData) {
                contentChanged.innerHTML = changedData.interpretation;
                tabChanged.textContent = `变卦：${changedData.name}`;
                tabChanged.style.display = 'inline-block';
            } else {
                tabChanged.style.display = 'none';
            }

            tabOriginal.classList.add('active');
            contentOriginal.classList.add('active');
            tabChanged.classList.remove('active');
            contentChanged.classList.remove('active');

            this.elements.interpretationModalOverlay.classList.add('visible');
        },

        // 根据数值（6,7,8,9）获取爻的信息
        getYaoInfo: function(value) {
             switch (value) {
                case 6: return { type: 'yin', isChanging: true, binary: '0', symbol: '×' };
                case 7: return { type: 'yang', isChanging: false, binary: '1', symbol: '' };
                case 8: return { type: 'yin', isChanging: false, binary: '0', symbol: '' };
                case 9: return { type: 'yang', isChanging: true, binary: '1', symbol: '×' };
                default: return { type: 'error', isChanging: false, binary: '', symbol: '' };
            }
        },
        
        // 获取变爻对应的爻值
        getChangedYaoValue: function(value) {
            if (value === 6) return 7;
            if (value === 9) return 8;
            return value;
        },

        // 创建单个爻的SVG DOM元素
        createYaoElement: function(info) {
            const yaoDiv = document.createElement('div');
            yaoDiv.className = `yao yao-${info.type}`;
            if(info.type === 'placeholder') return yaoDiv;
            const svgNS = "http://www.w3.org/2000/svg";
            const svg = document.createElementNS(svgNS, "svg");
            svg.setAttribute("viewBox", "0 0 100 10"); 
            svg.setAttribute("preserveAspectRatio", "none");
            if (info.type === 'yang') {
                const line = document.createElementNS(svgNS, "line");
                line.setAttribute("x1", "0"); line.setAttribute("y1", "5"); line.setAttribute("x2", "100"); line.setAttribute("y2", "5");
                line.setAttribute("stroke-width", "10");
                svg.appendChild(line);
            } else if (info.type === 'yin') {
                const line1 = document.createElementNS(svgNS, "line");
                line1.setAttribute("x1", "0"); line1.setAttribute("y1", "5"); line1.setAttribute("x2", "40"); line1.setAttribute("y2", "5");
                line1.setAttribute("stroke-width", "10");
                svg.appendChild(line1);
                const line2 = document.createElementNS(svgNS, "line");
                line2.setAttribute("x1", "60"); line2.setAttribute("y1", "5"); line2.setAttribute("x2", "100"); line2.setAttribute("y2", "5");
                line2.setAttribute("stroke-width", "10");
                svg.appendChild(line2);
            }
            yaoDiv.appendChild(svg);
            if (info.isChanging) {
                yaoDiv.classList.add('yao-changing');
                const symbol = document.createElement('div');
                symbol.className = 'yao-changing-symbol';
                symbol.textContent = info.symbol;
                yaoDiv.appendChild(symbol);
            }
            return yaoDiv;
        },

        // 将生成的本卦和变卦渲染到页面
        displayHexagrams: function(originalYaoValues) {
            this.elements.originalHexagram.innerHTML = '';
            this.elements.changedHexagram.innerHTML = '';
            originalYaoValues.forEach(value => {
                this.elements.originalHexagram.appendChild(this.createYaoElement(this.getYaoInfo(value)));
                this.elements.changedHexagram.appendChild(this.createYaoElement(this.getYaoInfo(this.getChangedYaoValue(value))));
            });
            gsap.from(this.elements.originalHexagram.children, { opacity: 0, stagger: 0.1 });
            gsap.from(this.elements.changedHexagram.children, { opacity: 0, stagger: 0.1 });
        },

        // 根据爻的二进制码查找并显示卦名和解释
        displayInterpretations: function(originalYaoValues) {
            const originalBinary = [...originalYaoValues].map(v => this.getYaoInfo(v).binary).reverse().join('');
            const changedBinary = [...originalYaoValues].map(v => this.getYaoInfo(this.getChangedYaoValue(v)).binary).reverse().join('');
            
            this.state.currentOriginalHexKey = originalBinary;
            this.state.currentChangedHexKey = originalBinary !== changedBinary ? changedBinary : null;

            const originalHexData = HEXAGRAM_DATA[originalBinary] || { name: '未知' };
            const changedHexData = HEXAGRAM_DATA[changedBinary] || { name: '未知' };
            this.elements.originalHexagramName.textContent = `${originalHexData.name}卦`;
            gsap.from(this.elements.originalHexagramName, { opacity: 0, y: 10, duration: 0.5, ease: 'power1.out' });
            if (originalBinary !== changedBinary) {
                this.elements.changedHexagramContainer.style.display = 'flex';
                this.elements.changedHexagramName.textContent = `${changedHexData.name}卦`;
                gsap.from(this.elements.changedHexagramName, { opacity: 0, y: 10, duration: 0.5, ease: 'power1.out' });
            } else {
                this.elements.changedHexagramContainer.style.display = 'none';
                this.elements.changedHexagramName.textContent = '';
            }
        },

        // --- 初始化与辅助功能 ---

        // 初始化视差效果（桌面端鼠标移动，移动端陀螺仪）
        initParallax: function() {
            const container = this.elements.mainContainer;
            if (this.state.isMobile) {
                const rotX = gsap.quickSetter(container, "rotationX", "deg");
                const rotY = gsap.quickSetter(container, "rotationY", "deg");
                let target = { x: 0, y: 0 };
                let current = { x: 0, y: 0 };
                const smoothing = 0.08;
                window.addEventListener('deviceorientation', (e) => {
                    const { beta, gamma } = e;
                    if (beta === null || gamma === null) return;
                    if (!this.state.isCalibrated) {
                        this.state.baseBeta = beta;
                        this.state.baseGamma = gamma;
                        this.state.isCalibrated = true;
                    }
                    const deltaBeta = beta - this.state.baseBeta;
                    const deltaGamma = gamma - this.state.baseGamma;
                    const clampedGamma = gsap.utils.clamp(-45, 45, deltaGamma);
                    const clampedBeta = gsap.utils.clamp(-45, 45, deltaBeta);
                    target.y = clampedGamma * 0.4;
                    target.x = -clampedBeta * 0.4;
                });
                gsap.ticker.add(() => {
                    current.x += (target.x - current.x) * smoothing;
                    current.y += (target.y - current.y) * smoothing;
                    rotX(current.x);
                    rotY(current.y);
                });
            } else {
                window.addEventListener('mousemove', (e) => {
                    const { clientX, clientY } = e;
                    const { innerWidth, innerHeight } = window;
                    const xOffset = (clientX / innerWidth - 0.5) * 2;
                    const yOffset = (clientY / innerHeight - 0.5) * 2;
                    gsap.to(container, { duration: 1.2, rotationY: xOffset * 8, rotationX: -yOffset * 8, ease: "power1.out" });
                });
            }
        },

        // 按钮点击发光特效
        addGlowEffect: function(button) {
            const glow = document.createElement('div');
            glow.className = 'button-glow-effect';
            button.appendChild(glow);
            setTimeout(() => glow.remove(), 600);
        },

        // 初始化应用，绑定所有事件监听器
        init: function() {
            this.elements.methodToggle.addEventListener('change', (e) => {
                this.state.divinationMethod = e.target.checked ? 'yarrow' : 'random';
                this.elements.labelYarrow.style.opacity = e.target.checked ? 1 : 0.7;
                this.elements.labelRandom.style.opacity = e.target.checked ? 0.7 : 1;
            });

            this.elements.divineButton.addEventListener('click', (e) => {
                this.addGlowEffect(e.currentTarget);
                this.startDivination();
            });

            // 添加点击事件来展开/收起演算面板
            this.elements.yaoStatsContainer.addEventListener('click', () => {
                this.elements.yaoStatsContainer.classList.toggle('collapsed');
            });

            this.elements.interpretationModalOverlay.addEventListener('click', (e) => {
                if (e.target === this.elements.interpretationModalOverlay) {
                    this.elements.interpretationModalOverlay.classList.remove('visible');
                }
            });
            document.getElementById('modal-close-btn').addEventListener('click', () => {
                this.elements.interpretationModalOverlay.classList.remove('visible');
            });
            document.getElementById('tab-original').addEventListener('click', () => {
                document.getElementById('tab-original').classList.add('active');
                document.getElementById('content-original').classList.add('active');
                document.getElementById('tab-changed').classList.remove('active');
                document.getElementById('content-changed').classList.remove('active');
            });
            document.getElementById('tab-changed').addEventListener('click', () => {
                document.getElementById('tab-original').classList.remove('active');
                document.getElementById('content-original').classList.remove('active');
                document.getElementById('tab-changed').classList.add('active');
                document.getElementById('content-changed').classList.add('active');
            });

            this.initParallax();

            window.addEventListener('resize', () => {
                if (this.state.animationRunning) {
                    this.setupCanvas();
                }
            });
        }
    };

    window.onload = () => {
        // 确保卦象数据加载完毕后再初始化应用
        if (typeof HEXAGRAM_DATA !== 'undefined') {
            app.init();
        } else {
            console.error('卦象数据 (HEXAGRAM_DATA) 未能从 data.js 加载。');
            document.body.innerHTML = '<div style="color: white; text-align: center; padding-top: 50px; font-size: 1.2em;">无法加载数据文件 (data.js)，请检查文件路径是否正确并刷新页面。</div>';
        }
        // 调整全局动画速率，优化性能和观感
        gsap.globalTimeline.timeScale(2.5);
    };
    </script>
</body>
</html>