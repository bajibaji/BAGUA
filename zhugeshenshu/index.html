<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>巧连神数</title>
    
    <!-- 引入 GSAP 动画库 -->
    <script src="https://cdn.jsdelivr.net/npm/gsap@3.12.5/dist/gsap.min.js"></script>
    <!-- 引入 opencc-js 用于简繁转换 -->
    <script src="https://cdn.jsdelivr.net/npm/opencc-js@1.0.5/dist/umd/full.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;700&display=swap');

        :root {
            --bg-color: #1a1a1a;
            --container-bg: rgba(44, 44, 44, 0.55);
            --primary-text: #e0e0e0;
            --title-color: #d4af37; /* 金色 */
            --border-color: #444;
            --button-bg: #8c735b;
            --button-hover-bg: #a0856a;
            --input-bg: rgba(0,0,0,0.2);
            --glow-color: rgba(212, 175, 55, 0.7);
            --result-bg: rgba(0,0,0,0.15);
            --error-color: #e57373;
            --cinnabar-red: #D24534; /* 朱砂红 */
            --cinnabar-red-hover: #e05a49;
        }
        
        body {
            font-family: 'Noto Serif SC', serif;
            background-color: var(--bg-color);
            color: var(--primary-text);
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            -webkit-tap-highlight-color: transparent;
            transition: background-color 0.5s ease;
            overflow: hidden;
            perspective: 1000px;
        }

        #background-bagua {
            position: fixed;
            top: 50%;
            left: 50%;
            width: 80vmax;
            height: 80vmax;
            transform: translate(-50%, -50%);
            z-index: -1;
            opacity: 0.08;
            animation: slow-rotate 120s linear infinite;
        }

        @keyframes slow-rotate {
            from { transform: translate(-50%, -50%) rotate(0deg); }
            to { transform: translate(-50%, -50%) rotate(360deg); }
        }

        .container {
            width: 95%;
            max-width: 600px;
            margin: auto;
            padding: 30px 40px;
            background-color: var(--container-bg);
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
            border: 1px solid var(--border-color);
            box-sizing: border-box;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            max-height: 95vh;
            overflow-y: auto;
            text-align: center;
        }

        h1 {
            color: var(--title-color);
            font-weight: 700;
            font-size: 2.5em;
            margin-bottom: 15px;
        }

        .container p {
            line-height: 1.8;
            font-size: 1.1em;
            margin-bottom: 30px;
            opacity: 0.8;
        }
        
        .input-grid {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 35px;
        }

        .char-input-main {
            width: 100%;
            height: 80px;
            border-radius: 10px;
            border: 1px solid var(--border-color);
            background: var(--input-bg);
            color: var(--primary-text);
            font-family: inherit;
            font-size: 2.5em;
            text-align: center;
            transition: all 0.3s ease;
            caret-color: var(--title-color);
            padding: 0 20px;
            box-sizing: border-box;
        }

        .char-input-main::placeholder {
            color: rgba(224, 224, 224, 0.4);
            font-size: 0.7em;
        }

        .char-input-main:focus {
            outline: none;
            border-color: var(--title-color);
            box-shadow: 0 0 0 3px var(--glow-color);
        }

        .button-wrapper {
            text-align: center;
            margin-top: 20px;
            position: relative;
        }

        button {
            font-family: inherit;
            font-size: 1.3em;
            padding: 12px 35px;
            background-color: var(--button-bg);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            position: relative;
            overflow: hidden;
            width: 240px;
            -webkit-backface-visibility: hidden;
            -moz-backface-visibility: hidden;
            transform: translate3d(0, 0, 0);
        }
        
        button:disabled {
            background-color: #555;
            color: #888;
            cursor: not-allowed;
            transform: none;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        button:hover:not(:disabled) {
            background-color: var(--button-hover-bg);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px var(--glow-color);
        }

        button:active:not(:disabled) {
            transform: translateY(0);
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        /* 进度条按钮样式 */
        #calculate-button .progress-bar {
            position: absolute;
            top: 0;
            left: 0;
            height: 100%;
            width: 0%; /* 初始宽度为0 */
            background-color: var(--title-color);
            border-radius: 8px;
            transition: width 0.1s linear;
            z-index: 1;
        }
        #calculate-button .button-text {
            position: relative;
            z-index: 2;
        }


        #result-container {
            margin-top: 35px;
            padding: 25px;
            background-color: var(--result-bg);
            border-radius: 8px;
            border: 1px solid var(--border-color);
            text-align: left;
            line-height: 2.2;
            font-size: 1.1em;
            opacity: 0; /* Initially hidden for animation */
            display: none; /* Initially hidden */
        }
        
        #result-container.visible {
            opacity: 1;
            display: block;
        }

        .result-line {
            display: flex;
            align-items: center;
            flex-wrap: nowrap;
            min-height: 40px;
            margin-bottom: 15px;
        }

        .result-line strong {
            color: var(--title-color);
            font-weight: 700;
            margin-right: 15px;
            white-space: nowrap;
        }
        
        .result-grid {
            display: flex;
            justify-content: flex-start;
            gap: 20px;
            width: 100%;
        }

        .char-result-item {
            width: 80px;
            font-size: 2em;
            text-align: center;
            line-height: 1;
        }
        
        .result-line-input .char-result-item,
        .result-line-traditional .char-result-item {
            font-size: 2.0em; /* 增大输入汉字字体 */
        }
        .result-line-strokes .char-result-item {
            font-size: 1.0em; /* 减小笔画字体 */
        }
        .result-line-process {
            font-size: 1.0em; /* 减小计算过程字体 */
            opacity: 0.9;
        }


        #final-result-line {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid var(--border-color);
            text-align: center;
        }
        
        .qian-shi-title {
            font-size: 1.2em;
            opacity: 0.8;
        }
        .qian-shi-text {
            font-size: 1.5em;
            font-weight: bold;
            line-height: 1.8;
            margin: 10px 0 20px;
            white-space: pre-wrap;
            color: var(--title-color); /* 签诗文本使用金色 */
        }

        #error-message {
            color: var(--error-color);
            margin-top: 20px;
            height: 20px;
            font-size: 1em;
            transition: opacity 0.3s;
        }

        .explanation-button {
            font-size: 1.1em;
            padding: 8px 25px;
            background-color: var(--cinnabar-red);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        .explanation-button:hover:not(:disabled) {
            background-color: var(--cinnabar-red-hover);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(210, 69, 52, 0.4);
        }

        .jie-qian-container {
            margin-top: 25px;
            padding-top: 20px;
            border-top: 1px solid var(--border-color);
            text-align: left;
            opacity: 0.9;
            overflow: hidden;
        }
        .jie-qian-title {
            font-size: 1.2em;
            font-weight: bold;
            color: var(--title-color);
            margin-bottom: 15px;
            text-align: center;
        }
        .jie-qian-text {
            font-size: 1.1em;
            line-height: 1.9;
            margin-bottom: 10px;
        }
        .jie-qian-text strong {
            color: var(--primary-text);
        }
        
        @media (max-width: 480px) {
            body {
                padding: 10px 5px;
                align-items: flex-start; /* Align to top on mobile */
                overflow-y: auto; /* Allow vertical scrolling on mobile */
            }
            .container {
                padding: 20px 15px;
                max-height: none; /* Allow container to grow */
            }
            h1 { font-size: 2em; }
            .input-grid { 
                gap: 10px; 
                width: 100%;
            }
            .char-input-main {
                height: auto;
                aspect-ratio: 4 / 1;
                font-size: 2em;
            }
            
            .result-line {
                flex-direction: column; /* Stack label and grid vertically */
                align-items: flex-start; /* Align to the left */
                gap: 8px;
                margin-bottom: 20px;
            }

            .result-line strong {
                margin-right: 0;
                margin-bottom: 0;
            }

            .result-grid {
                gap: 10px;
                width: 100%;
                justify-content: space-between; /* Evenly space items */
            }
            
            .char-result-item {
                font-size: 1.8em;
                flex: 1 1 0;
                width: 0; /* Let flexbox control width */
                min-width: 40px;
                max-width: 80px;
            }
            
            .calculation-line {
                flex-direction: row; /* Keep calculation line horizontal */
                flex-wrap: wrap; /* But allow it to wrap if needed */
                align-items: center;
                gap: 5px; /* Smaller gap for wrapped content */
            }
        }
    </style>
</head>
<body>

<div id="background-bagua">
        <svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg" fill="none" stroke="currentColor" color="var(--primary-text)">
            <defs>
                <g id="yang-line"><path d="M -4.5,0 L 4.5,0" stroke-width="1.5" stroke-linecap="butt"></path></g>
                <g id="yin-line"><path d="M -4.5,0 L -1.5,0 M 1.5,0 L 4.5,0" stroke-width="1.5" stroke-linecap="butt"></path></g>
            </defs>
            <g stroke-width="0.5">
                <circle cx="50" cy="50" r="48"></circle><circle cx="50" cy="50" r="44"></circle>
                <circle cx="50" cy="50" r="35"></circle><circle cx="50" cy="50" r="34"></circle>
                <circle cx="50" cy="50" r="26"></circle><circle cx="50" cy="50" r="25"></circle>
                <circle cx="50" cy="50" r="17"></circle><circle cx="50" cy="50" r="16"></circle>
            </g>
            <g stroke-width="0">
                <path d="M50 16 A 34 34 0 0 0 50 84 Z" fill="var(--bg-color)"></path>
                <path d="M50 16 A 34 34 0 0 1 50 84 Z" fill="currentColor"></path>
                <circle cx="50" cy="67" r="17" fill="currentColor"></circle>
                <circle cx="50" cy="33" r="17" fill="var(--bg-color)"></circle>
                <circle cx="50" cy="33" r="4" fill="currentColor"></circle>
                <circle cx="50" cy="67" r="4" fill="var(--bg-color)"></circle>
            </g>
            <g transform="translate(50 50)">
                 <g transform="translate(0, -39.5)"><use href="#yang-line" y="3"></use><use href="#yang-line" y="0"></use><use href="#yang-line" y="-3"></use></g>
                 <g transform="rotate(45) translate(0, -39.5)"><use href="#yin-line" y="3"></use><use href="#yang-line" y="0"></use><use href="#yang-line" y="-3"></use></g>
                 <g transform="rotate(90) translate(0, -39.5)"><use href="#yin-line" y="3"></use><use href="#yang-line" y="0"></use><use href="#yin-line" y="-3"></use></g>
                 <g transform="rotate(135) translate(0, -39.5)"><use href="#yin-line" y="3"></use><use href="#yin-line" y="0"></use><use href="#yang-line" y="-3"></use></g>
                 <g transform="rotate(180) translate(0, -39.5)"><use href="#yin-line" y="3"></use><use href="#yin-line" y="0"></use><use href="#yin-line" y="-3"></use></g>
                 <g transform="rotate(225) translate(0, -39.5)"><use href="#yang-line" y="3"></use><use href="#yin-line" y="0"></use><use href="#yin-line" y="-3"></use></g>
                 <g transform="rotate(270) translate(0, -39.5)"><use href="#yang-line" y="3"></use><use href="#yin-line" y="0"></use><use href="#yang-line" y="-3"></use></g>
                 <g transform="rotate(315) translate(0, -39.5)"><use href="#yang-line" y="3"></use><use href="#yang-line" y="0"></use><use href="#yin-line" y="-3"></use></g>
            </g>
        </svg>
    </div>

    <div class="container">
        <h1><b>巧连神数</b></h1>
        <p>请输入任意三个汉字，系统将为您推演命运之数。</p>

        <div class="input-grid">
            <input type="text" id="char-input-main" class="char-input-main" placeholder="请在此输入三个汉字">
        </div>
        
        <div id="error-message"></div>

        <div class="button-wrapper">
            <button id="calculate-button" disabled>
                <div class="progress-bar"></div>
                <span class="button-text">准备加载...</span>
            </button>
        </div>

        <div id="result-container">
            <div id="result-details"></div>
        </div>
    </div>
    
    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const DATA_VERSION = '1.2'; // 增加版本号以清除旧缓存
        let KANGXI_STROKE_MAP = null;
        let QIAN_SHI_MAP = null;
        const converter = OpenCC.Converter({ from: 'cn', to: 't' });

        // DOM Elements
        const mainInput = document.getElementById('char-input-main');
        const calculateButton = document.getElementById('calculate-button');
        const resultContainer = document.getElementById('result-container');
        const resultDetails = document.getElementById('result-details');
        const errorMessage = document.getElementById('error-message');
        const buttonText = calculateButton.querySelector('.button-text');
        const progressBar = calculateButton.querySelector('.progress-bar');
        
        const progressState = {
            kangxi: 0,
            qianShi: 0,
            total: 0
        };

        /**
         * 更新UI上的进度条
         */
        function updateProgressUI() {
            progressState.total = (progressState.kangxi + progressState.qianShi) / 2;
            const percentage = Math.round(progressState.total);
            progressBar.style.width = `${percentage}%`;
            buttonText.textContent = `加载数据... ${percentage}%`;

            if (percentage >= 100) {
                setTimeout(() => {
                    gsap.to(progressBar, { opacity: 0, duration: 0.5 });
                    buttonText.textContent = '开始计算';
                    calculateButton.disabled = false;
                }, 200);
            }
        }
        
        /**
         * 带进度的Fetch函数 (用于加载 384.JSON)
         */
        async function fetchWithProgress(url, onProgress) {
            try {
                const response = await fetch(url);
                if (!response.ok) throw new Error(`网络响应错误: ${response.statusText}`);
                
                const contentLength = +response.headers.get('Content-Length');
                if (!contentLength) { // 如果没有Content-Length，则使用普通fetch
                    const data = await response.json();
                    onProgress(100);
                    return data;
                }

                const reader = response.body.getReader();
                let receivedLength = 0;
                let chunks = [];
                
                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;
                    chunks.push(value);
                    receivedLength += value.length;
                    const progress = (receivedLength / contentLength) * 100;
                    onProgress(progress);
                }
                
                let chunksAll = new Uint8Array(receivedLength);
                let position = 0;
                for(let chunk of chunks) {
                    chunksAll.set(chunk, position);
                    position += chunk.length;
                }
                
                const resultText = new TextDecoder("utf-8").decode(chunksAll);
                return JSON.parse(resultText);

            } catch (error) {
                 console.error(`加载 ${url} 失败:`, error);
                 errorMessage.textContent = '错误: 数据文件加载失败。';
                 throw error;
            }
        }
        
        /**
         * [新功能] 并行加载拆分后的康熙字典文件
         */
        async function loadKangxiParts() {
            const cacheKey = 'KANGXI_STROKE_MAP_PARTS';
            try {
                const cachedData = localStorage.getItem(cacheKey);
                if (cachedData) {
                    const { version, data } = JSON.parse(cachedData);
                    if (version === DATA_VERSION) {
                        console.log('康熙字典数据从缓存加载。');
                        progressState.kangxi = 100;
                        return data;
                    }
                }
            } catch (e) { console.error(`读取 ${cacheKey} 缓存失败:`, e); }

            const totalParts = 128;
            let loadedParts = 0;
            const promises = [];

            for (let i = 1; i <= totalParts; i++) {
                const url = `./kangxi_parts/kangxi_part_${i}.json`;
                const promise = fetch(url)
                    .then(res => {
                        if (!res.ok) throw new Error(`加载 ${url} 失败`);
                        return res.json();
                    })
                    .then(data => {
                        loadedParts++;
                        progressState.kangxi = (loadedParts / totalParts) * 100;
                        updateProgressUI();
                        return data;
                    });
                promises.push(promise);
            }
            
            const allPartsData = await Promise.all(promises);
            
            // 合并所有数据块并转换为Map
            const combinedData = allPartsData.flat(); // [[...], [...]] -> [...]
            const strokeMap = combinedData.reduce((acc, item) => {
                if (item.char && typeof item.N !== 'undefined') acc[item.char] = item.N;
                return acc;
            }, {});

            try {
                localStorage.setItem(cacheKey, JSON.stringify({ version: DATA_VERSION, data: strokeMap }));
                console.log('康熙字典数据已获取、合并并缓存。');
            } catch (e) {
                console.error(`缓存 ${cacheKey} 数据失败:`, e);
            }

            return strokeMap;
        }

        /**
         * [修改] 加载384签诗数据的函数
         */
        async function loadQianShiData() {
            const cacheKey = 'QIAN_SHI_MAP';
            try {
                const cachedData = localStorage.getItem(cacheKey);
                if (cachedData) {
                    const { version, data } = JSON.parse(cachedData);
                    if (version === DATA_VERSION) {
                        console.log('签诗数据从缓存加载。');
                        progressState.qianShi = 100;
                        return data;
                    }
                }
            } catch (e) { console.error(`读取 ${cacheKey} 缓存失败:`, e); }

            const data = await fetchWithProgress('./384.JSON', (progress) => {
                progressState.qianShi = progress;
                updateProgressUI();
            });

            const qianShiMap = data.reduce((acc, item) => {
                let num = null;
                if (item && typeof item.num !== 'undefined') {
                    if (typeof item.num === 'string') {
                        const numMatch = item.num.match(/\d+/);
                        if (numMatch) num = parseInt(numMatch[0], 10);
                    } else if (typeof item.num === 'number') num = item.num;
                }
                if (num !== null) acc[num] = { yeah: item.yeah, shit1: item.shit1, shit2: item.shit2 };
                return acc;
            }, {});

            try {
                localStorage.setItem(cacheKey, JSON.stringify({ version: DATA_VERSION, data: qianShiMap }));
                 console.log('签诗数据已获取并缓存。');
            } catch(e) {
                console.error(`缓存 ${cacheKey} 数据失败:`, e);
            }
            return qianShiMap;
        }

        async function initializeAllData() {
            updateProgressUI(); // 初始显示0%
            try {
                const [kangxiMap, qianShiMap] = await Promise.all([
                    loadKangxiParts(),
                    loadQianShiData()
                ]);
                
                KANGXI_STROKE_MAP = kangxiMap;
                QIAN_SHI_MAP = qianShiMap;
                
                // 确保缓存加载时也能正确完成进度条
                updateProgressUI();

            } catch (error) {
                buttonText.textContent = '加载失败';
                calculateButton.style.backgroundColor = 'var(--error-color)';
                 console.error("初始化数据失败:", error);
            }
        }
        
        initializeAllData();

        /**
         * 查询单个汉字的数据
         */
        async function lookupCharData(char) {
            const traditionalChar = await converter(char);
            if (KANGXI_STROKE_MAP && KANGXI_STROKE_MAP.hasOwnProperty(traditionalChar)) {
                return {
                    input: char,
                    traditional: traditionalChar,
                    strokes: KANGXI_STROKE_MAP[traditionalChar],
                };
            }
            return null;
        }

        // --- UI交互逻辑 (未改变) ---
        mainInput.addEventListener('input', () => {
            errorMessage.textContent = '';
            resultContainer.classList.remove('visible');
        });

        calculateButton.addEventListener('click', async () => {
            if (calculateButton.disabled) return;

            errorMessage.textContent = '';
            resultContainer.classList.remove('visible');
            gsap.set(resultContainer, {opacity: 0});

            calculateButton.disabled = true;
            buttonText.textContent = '计算中...';

            const rawInput = mainInput.value;
            const chars = (rawInput.match(/[\u4e00-\u9fa5]/g) || []).slice(0, 3);

            if (chars.length !== 3) {
                errorMessage.textContent = '请输入三个汉字。';
                calculateButton.disabled = false;
                buttonText.textContent = '开始计算';
                return;
            }

            const charData = await Promise.all(chars.map(lookupCharData));
            if (charData.some(d => d === null)) {
                const failedIndex = charData.findIndex(d => d === null);
                errorMessage.textContent = `抱歉，字库中未找到“${chars[failedIndex]}”的笔画信息。`;
                calculateButton.disabled = false;
                buttonText.textContent = '开始计算';
                return;
            }

            const s1 = charData[0].strokes, s2 = charData[1].strokes, s3 = charData[2].strokes;
            const totalValue = s1 * 100 + s2 * 10 + s3;
            let finalResult = totalValue;
            while (finalResult > 384) {
                finalResult -= 384;
            }

            const qianData = QIAN_SHI_MAP[finalResult];
            let finalResultHTML = `<div class="qian-shi-title">未找到对应的签诗</div>`;
            if (qianData) {
                finalResultHTML = `
                    <div class="qian-shi-title">第 ${finalResult} 籤</div>
                    <div class="qian-shi-text">${qianData.yeah}</div>
                    <button id="toggle-explanation-button" class="explanation-button" data-expanded="false">解 籤</button>
                    <div class="jie-qian-container" style="display:none; height:0; opacity:0;">
                        <div class="jie-qian-title">【解籤】</div>
                        <p class="jie-qian-text"><strong>解籤一：</strong> ${qianData.shit1}</p>
                        <p class="jie-qian-text"><strong>解籤二：</strong> ${qianData.shit2}</p>
                    </div>
                `;
            }

            const inputCharsHTML = charData.map(d => `<div class="char-result-item">${d.input}</div>`).join('');
            const traditionalCharsHTML = charData.map(d => `<div class="char-result-item">${d.traditional}</div>`).join('');
            const strokesHTML = charData.map(d => `<div class="char-result-item">${d.strokes}</div>`).join('');
            const needsTraditionalLine = charData.some(d => d.input !== d.traditional);
            const traditionalLineHTML = needsTraditionalLine ? `<div class="result-line result-line-traditional"><strong>计算汉字:</strong><div class="result-grid">${traditionalCharsHTML}</div></div>` : '';

            resultDetails.innerHTML = `
                <div class="result-line result-line-input"><strong>输入汉字:</strong><div class="result-grid">${inputCharsHTML}</div></div>
                ${traditionalLineHTML}
                <div class="result-line result-line-strokes"><strong>康熙笔画:</strong><div class="result-grid">${strokesHTML}</div></div>
                <div class="result-line calculation-line result-line-process" style="margin-top: 10px;"><strong>计算过程:</strong> (${s1}×100) + (${s2}×10) + ${s3} = ${totalValue}</div>
                <div id="final-result-line">${finalResultHTML}</div>
            `;
            
            resultContainer.classList.add('visible');
            calculateButton.disabled = false;
            buttonText.textContent = '开始计算';

            gsap.timeline({
                onComplete: () => { if (window.innerWidth <= 480) resultContainer.scrollIntoView({ behavior: 'smooth', block: 'start' }); }
            }).to(resultContainer, {opacity: 1, duration: 0.2})
              .from("#result-details > .result-line, #result-details > #final-result-line", { opacity: 0, y: 15, duration: 0.5, ease: 'power2.out', stagger: 0.15 });
        });

        resultDetails.addEventListener('click', (e) => {
            if (e.target.id === 'toggle-explanation-button') {
                const button = e.target;
                const container = button.nextElementSibling;
                const isExpanded = button.dataset.expanded === 'true';

                if (!isExpanded) {
                    button.dataset.expanded = 'true';
                    button.textContent = '收 起';
                    
                    gsap.set(container, { display: 'block', height: 'auto' });
                    const autoHeight = container.offsetHeight;
                    
                    gsap.fromTo(container, { height: 0, opacity: 0 }, { 
                        height: autoHeight, 
                        opacity: 1, 
                        duration: 0.5, 
                        ease: 'power2.out',
                        onComplete: () => {
                            if (window.innerWidth <= 480) {
                                setTimeout(() => {
                                   container.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                                }, 100);
                            }
                        }
                    });
                } else {
                    button.dataset.expanded = 'false';
                    button.textContent = '解 籤';

                    gsap.to(container, { 
                        height: 0, 
                        opacity: 0, 
                        duration: 0.5, 
                        ease: 'power2.in', 
                        onComplete: () => {
                            container.style.display = 'none';
                        }
                    });
                }
            }
        });
    });
    </script>
</body>
</html>
