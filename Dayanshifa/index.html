<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>大衍筮法 v1.0</title>
    
    <!-- 引入 GSAP 动画库 -->
    <script src="https://cdn.jsdelivr.net/npm/gsap@3.12.5/dist/gsap.min.js"></script>
    <script src="data.js" defer></script>
    <!-- [NEW] 引入白话文解释文件 -->
    <script src="other.js" defer></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;700&display=swap');

        :root {
            /* 暗色主题 (默认) */
            --bg-color: #1a1a1a;
            --container-bg: rgba(44, 44, 44, 0.55);
            --primary-text: #e0e0e0;
            --title-color: #d4af37;
            --border-color: #444;
            --button-bg: #8c735b;
            --button-hover-bg: #a0856a;
            --hexagram-bg: #333;
            --changing-yao-color: #b43f3f;
            --glow-color: rgba(212, 175, 55, 0.7);
            --original-hex-color: #d1d1d1;
            --changed-hex-color: #afafaf;
            --stalk-color: #f0e68c; /* 蓍草颜色 */
            --modal-bg: rgba(44, 44, 44, 0.85);
            --modal-border: #555;
            /* 鎏金文字渐变 */
            --gold-text-gradient: linear-gradient(135deg, #bf953f 0%, #fcf6ba 25%, #b38728 50%, #fbf5b7 75%, #aa771c 100%);
        }
        
        /* 明亮主题 */
        :root.light-theme {
            --bg-color: #f5f0e8;
            --container-bg: rgba(255, 255, 255, 0.7);
            --primary-text: #333333;
            --title-color: #9c7c38;
            --border-color: #d0c8b0;
            --button-bg: #b39b6f;
            --button-hover-bg: #c9af7e;
            --hexagram-bg: #f0e8d8;
            --changing-yao-color: #d04848;
            --glow-color: rgba(179, 155, 111, 0.5);
            --original-hex-color: #1f1d16;
            --changed-hex-color: #493c3d;
            --stalk-color: #d4c88c;
            --modal-bg: rgba(255, 255, 255, 0.9);
            --modal-border: #d0c8b0;
        }

        /* 鎏金文字渐变 */
        .text-gold-gradient {
            background: var(--gold-text-gradient);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            /* 增强 text-shadow 以获得更强的光晕效果 */
            text-shadow: 0 2px 8px rgba(212, 175, 55, 0.3), 0 0 20px rgba(255, 215, 0, 0.2);
        }

        body {
            font-family: 'Noto Serif SC', serif;
            background-color: var(--bg-color);
            color: var(--primary-text);
            margin: 0;
            padding: 10px;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            -webkit-tap-highlight-color: transparent;
            transition: background-color 0.5s ease;
            overflow: hidden;
            perspective: 1000px;
        }

        #background-bagua {
            position: fixed;
            top: 50%;
            left: 50%;
            width: 80vmax;
            height: 80vmax;
            transform: translate(-50%, -50%);
            z-index: -1;
            opacity: 0.08;
            animation: slow-rotate 120s linear infinite;
        }

        @keyframes slow-rotate {
            from { transform: translate(-50%, -50%) rotate(0deg); }
            to { transform: translate(-50%, -50%) rotate(360deg); }
        }

        /* [新增] 噪点纹理 */
        .noise-overlay {
            position: fixed; inset: 0; pointer-events: none; z-index: 50; opacity: 0.04;
            background: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)'/%3E%3C/svg%3E");
        }

        body.divining {
            background-color: #000;
        }
        body.divining::before {
            content: '';
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: radial-gradient(circle at center, transparent 40%, #000 85%);
            z-index: 99;
            pointer-events: none;
            opacity: 0;
            animation: fadeInVignette 1s ease forwards;
        }

        @keyframes fadeInVignette { to { opacity: 1; } }

        .container {
            max-width: 800px; width: 95%; margin: auto; padding: 30px;
            background-color: var(--container-bg);
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
            border: 1px solid var(--border-color);
            box-sizing: border-box;
            transition: opacity 0.5s ease, transform 0.2s ease-out;
            opacity: 0;
            animation: fadeInContainer 1s 0.2s ease forwards;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            transform-style: preserve-3d;
            max-height: 95vh;
            overflow-y: auto;
        }

        @keyframes fadeInContainer { to { opacity: 1; } }

        h1, h2, h3 { color: var(--title-color); text-align: center; font-weight: 700; }
        h1 { font-size: 2.7em; margin-bottom: -15px; }
        h2 { border-bottom: 1px solid var(--border-color); padding-bottom: 15px; margin-top: 40px; margin-bottom: 20px; }
        .section p { text-align: center; line-height: 1.8; font-size: 0.9em; margin-bottom: 20px; }
        
        .method-selector {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 25px;
        }
        .method-selector label {
            margin: 0 10px;
            font-size: 1.1em;
            color: var(--primary-text);
            opacity: 0.7;
            transition: opacity 0.3s ease;
        }
        .method-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 28px;
        }
        .method-switch input { display: none; }
        
        /* --- 修复: 切换开关样式 --- */
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: var(--hexagram-bg);
            border: 1px solid var(--border-color);
            transition: .4s;
            border-radius: 28px;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 22px; width: 22px;
            left: 2px;
            bottom: 2px;
            background-color: var(--button-bg);
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .slider { 
            background-color: var(--title-color); 
            border-color: var(--title-color);
        }
        input:checked + .slider:before { 
            transform: translateX(22px); 
            background-color: var(--bg-color); 
        }
        #label-yarrow { opacity: 1; }

        .button-wrapper { text-align: center; margin-top: 20px; position: relative; min-height: 50px; display: flex; justify-content: center; align-items: center; gap: 12px;}
        /* --- [REVISED] 统一按钮体系：更克制、更有质感 --- */
        button {
            --btn-bg: var(--button-bg);
            --btn-bg-hover: var(--button-hover-bg);
            --btn-text: var(--primary-text);
            --btn-border: color-mix(in srgb, var(--border-color) 70%, transparent);

            font-family: inherit;
            font-size: 1.1em;
            padding: 12px 22px;
            border-radius: 12px;
            border: 1px solid var(--btn-border);
            color: var(--btn-text);
            cursor: pointer;
            position: relative;
            overflow: hidden;

            background:
                linear-gradient(180deg, rgba(255,255,255,0.12), rgba(0,0,0,0.18)),
                linear-gradient(135deg, color-mix(in srgb, var(--btn-bg) 78%, var(--title-color)), var(--btn-bg));

            box-shadow:
                0 8px 22px rgba(0,0,0,0.28),
                inset 0 1px 0 rgba(255,255,255,0.10);

            transition:
                transform 0.18s ease,
                box-shadow 0.22s ease,
                background 0.22s ease,
                border-color 0.22s ease,
                opacity 0.22s ease;

            -webkit-tap-highlight-color: transparent;
        }

        /* 「开始卜卦」按钮升级：致敬鎏金卦盘的视觉语汇 */
        #divine-button {
            --btn-bg: color-mix(in srgb, var(--title-color) 78%, #3a2a0d 22%);
            --btn-bg-hover: color-mix(in srgb, var(--title-color) 90%, #483517 10%);
            --btn-text: #fff9e6;

            /* 缩小尺寸以减少视觉重量 */
            font-size: clamp(1rem, 0.95rem + 0.4vw, 1.15rem);
            padding: 10px 28px;
            letter-spacing: 0.14em;
            font-weight: 700;
            border-radius: 12px;
            border: 1px solid color-mix(in srgb, var(--title-color) 72%, transparent);
            box-shadow:
                0 10px 24px rgba(0,0,0,0.40),
                0 0 0 1px rgba(255,255,255,0.06),
                inset 0 1px 2px rgba(255,255,255,0.28);
            z-index: 0;
        }

        #divine-button::after {
            content: "";
            position: absolute;
            inset: -8px;
            border-radius: 20px;
            background: transparent; /* 禁用金色径向光晕 */
            opacity: 0;
            transition: opacity 0.4s ease;
            z-index: -1;
            pointer-events: none;
        }

        /* 去掉 hover 时的金色光晕，保持轻微升起效果（更小） */
        #divine-button:hover:not(:disabled) {
            letter-spacing: 0.16em;
            transform: translateY(-2px);
            border-color: color-mix(in srgb, var(--title-color) 85%, transparent);
            box-shadow:
                0 12px 28px rgba(0,0,0,0.44),
                0 0 0 1px rgba(255,255,255,0.08);
        }

        /* 确保 ::after 不会显现 */
        #divine-button:hover:not(:disabled)::after { opacity: 0; }

        #divine-button:active:not(:disabled) {
            transform: translateY(0);
            box-shadow:
                0 8px 18px rgba(0,0,0,0.40),
                inset 0 3px 8px rgba(0,0,0,0.32);
            letter-spacing: 0.12em;
        }

        /* 保留可访问的 focus，但移除金色 glow */
        #divine-button:focus-visible {
            outline: none;
            box-shadow: 0 0 0 3px color-mix(in srgb, var(--title-color) 20%, transparent), 0 12px 28px rgba(0,0,0,0.28);
        }

        #divine-button:disabled {
            --btn-text: color-mix(in srgb, #c9b89a 70%, #6b5a35);
            border-color: color-mix(in srgb, var(--title-color) 20%, transparent);
            background:
                linear-gradient(180deg, rgba(255,255,255,0.10), rgba(0,0,0,0.18)),
                linear-gradient(135deg, color-mix(in srgb, var(--btn-bg) 55%, #2c1f08 45%), color-mix(in srgb, var(--btn-bg) 35%, #140d03));
            opacity: 0.65;
            box-shadow: none;
        }

        :root.light-theme #divine-button {
            --btn-text: #3d2b0c;
            --btn-bg: color-mix(in srgb, var(--title-color) 55%, #f6ead1 45%);
            --btn-bg-hover: color-mix(in srgb, var(--title-color) 70%, #f4e2b7 30%);
            box-shadow:
                0 12px 26px rgba(179,155,111,0.35),
                inset 0 1px 1px rgba(255,255,255,0.45);
        }

        :root.light-theme #divine-button::after {
            background: radial-gradient(circle at center, rgba(179,155,111,0.32) 0%, rgba(179,155,111,0.06) 55%, transparent 75%);
        }

        /* 顶部高光“丝绸感” */
        button::before {
            content: "";
            position: absolute;
            inset: 0;
            background: linear-gradient(120deg, transparent 0%, rgba(255,255,255,0.22) 35%, transparent 70%);
            transform: translateX(-35%);
            opacity: 0;
            transition: transform 0.35s ease, opacity 0.25s ease;
            pointer-events: none;
        }

        button:hover:not(:disabled) {
            transform: translateY(-2px);
            border-color: color-mix(in srgb, var(--title-color) 55%, var(--border-color));
            background:
                linear-gradient(180deg, rgba(255,255,255,0.14), rgba(0,0,0,0.15)),
                linear-gradient(135deg, color-mix(in srgb, var(--btn-bg-hover) 78%, var(--title-color)), var(--btn-bg-hover));
            box-shadow:
                0 14px 34px rgba(0,0,0,0.35),
                0 0 0 1px rgba(255,255,255,0.06),
                0 10px 22px rgba(0,0,0,0.28);
        }

        button:hover:not(:disabled)::before {
            transform: translateX(35%);
            opacity: 0.9;
        }

        button:active:not(:disabled) {
            transform: translateY(0);
            box-shadow:
                0 8px 18px rgba(0,0,0,0.30),
                inset 0 2px 10px rgba(0,0,0,0.20);
        }

        button:focus-visible {
            outline: none;
            box-shadow:
                0 0 0 3px color-mix(in srgb, var(--border-color) 45%, transparent),
                0 12px 30px rgba(0,0,0,0.32);
        }

        button:disabled {
            cursor: not-allowed;
            opacity: 0.55;
            transform: none;
            box-shadow: none;
            background:
                linear-gradient(180deg, rgba(255,255,255,0.06), rgba(0,0,0,0.22)),
                linear-gradient(135deg, color-mix(in srgb, var(--button-bg) 55%, var(--bg-color)), var(--bg-color));
        }

        /* --- 单独设置卦象解释按钮颜色 --- */
        #interp-button {
            --btn-bg: #c93756; /* 保持原色，但纳入统一按钮体系 */
            --btn-bg-hover: #e04a69;
            border-color: color-mix(in srgb, #c93756 55%, var(--border-color));
        }
        #interp-button:hover:not(:disabled) { border-color: color-mix(in srgb, #e04a69 60%, var(--border-color)); }

        .button-glow-effect {
            position: absolute; top: 50%; left: 50%; width: 10px; height: 10px;
            background: var(--title-color); border-radius: 50%;
            transform: translate(-50%, -50%) scale(0); opacity: 0.7;
            animation: button-glow 0.6s ease-out;
        }
        @keyframes button-glow { to { transform: translate(-50%, -50%) scale(20); opacity: 0; } }

        .loader {
            width: 18px; height: 18px; border: 2px solid #FFF; border-bottom-color: transparent;
            border-radius: 50%; display: inline-block; box-sizing: border-box;
            animation: rotation 1s linear infinite; margin-left: 10px; vertical-align: middle;
        }
        @keyframes rotation { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* 页面加载动画样式 */
        #page-loader {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--bg-color);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            transition: opacity 0.5s ease, visibility 0.5s ease;
        }
        .loader-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
        }
        .loader-symbol {
            font-size: 4rem;
            color: var(--title-color);
            animation: float 2s ease-in-out infinite, rotate 6s linear infinite;
            text-shadow: 0 0 8px color-mix(in srgb, var(--border-color) 30%, transparent);
        }
        .loader-text {
            color: var(--primary-text);
            font-size: 1.2rem;
            letter-spacing: 3px;
        }
        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-15px); }
        }
        @keyframes rotate {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* 进度条样式 - 无文字说明 */
        #divination-progress-bar {
            position: fixed;
            top: 0;
            left: 0;
            width: 0%;
            height: 4px;
            background: linear-gradient(90deg, var(--title-color), #f0e68c, var(--title-color));
            z-index: 101;
            transition: width 0.3s ease-out;
            box-shadow: 0 0 10px var(--glow-color), 0 0 20px var(--glow-color);
        }

        #interactive-animation-container {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,6.6);
            z-index: 100;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            opacity: 0; pointer-events: none; transition: opacity 0.5s ease;
        }
        #interactive-animation-container.visible { opacity: 1; pointer-events: all; }
        #interaction-prompt { color: var(--title-color); font-size: 1.5em; margin-bottom: 20px; text-shadow: 0 0 8px color-mix(in srgb, var(--border-color) 28%, transparent); min-height: 1.5em;}
        #stalks-wrapper {
            width: 80%; max-width: 500px; height: 150px;
            display: flex; justify-content: center; align-items: center;
            cursor: pointer; border: 2px dashed var(--border-color); border-radius: 10px;
            padding: 10px; position: relative;
        }
        .stalk {
            position: absolute; width: 2px; height: 100px;
            background: linear-gradient(to right, transparent, var(--stalk-color) 25%, var(--stalk-color) 75%, transparent);
            border-radius: 2px;
            transform-origin: bottom center;
            will-change: transform, opacity;
        }

        #yao-stats-container {
            position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%) scale(0.8); width: 90%; max-width: 400px;
            background: rgba(0,0,0,0.5); border-radius: 8px; padding: 10px; border: 1px solid var(--border-color);
            display: flex; flex-direction: column; align-items: center; gap: 8px; opacity: 0;
            transition: opacity 0.5s ease; color: var(--primary-text);
            transform-origin: bottom center;
        }
        .yao-stats-title { font-size: 1em; color: var(--title-color); font-weight: bold; }
        .yao-stats-changes { display: flex; justify-content: center; gap: 10px; width: 100%; }
        .change-stat { background: rgba(255,255,255,0.1); padding: 5px 8px; border-radius: 4px; font-size: 0.8em; text-align: center; }
        .change-stat .label { font-size: 0.9em; opacity: 0.7; }
        .change-stat .value { font-weight: bold; margin-top: 2px; }
        .yao-stats-result { font-size: 1.1em; font-weight: bold; margin-top: 5px; background: var(--button-bg); padding: 4px 12px; border-radius: 5px; }

        #result-container { display: none; margin-top: 30px; }
        .hexagram-display { display: flex; justify-content: space-around; margin-top: 20px; padding: 20px; background-color: var(--hexagram-bg); border-radius: 8px; border: 1px solid var(--border-color); }
        .hexagram { display: flex; flex-direction: column; align-items: center; text-align: center; }
        .hexagram h3 { font-size: 1.5em; margin-bottom: 15px; }
        .yao-lines { display: flex; flex-direction: column-reverse; }
        .hexagram-name { margin-top: 15px; font-size: 1.8em; font-weight: bold; height: 1.5em; letter-spacing: 2px; text-shadow: 0 0 8px rgba(0,0,0,0.5); }
        #original-hexagram-name { color: var(--original-hex-color); }
        #changed-hexagram-name { color: var(--changed-hex-color); }
        .yao { display: flex; justify-content: center; align-items: center; height: 25px; margin: 8px 0; position: relative; width: 120px; }
        .yao svg { width: 100%; height: 8px; display: block; }
        .yao svg line { stroke: var(--primary-text); transition: stroke 0.3s ease; }
        .yao.yao-changing svg line { stroke: var(--changing-yao-color); }
        .yao-changing-symbol { position: absolute; right: -25px; top: 50%; transform: translateY(-50%); font-size: 1.2em; color: var(--changing-yao-color); font-weight: bold; }
        
        /* --- 解释弹窗样式 --- */
        #interpretation-modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.7); 
            backdrop-filter: blur(5px);
            z-index: 200; display: flex; justify-content: center; align-items: center;
            opacity: 0; pointer-events: none; transition: opacity 0.3s ease;
        }
        #interpretation-modal-overlay.visible { opacity: 1; pointer-events: all; }
        #interpretation-modal {
            width: 90%; max-width: 600px; background: var(--container-bg);
            border-radius: 10px; border: 1px solid var(--border-color);
            box-shadow: 0 10px 40px rgba(0,0,0,0.5); display: flex; flex-direction: column;
            max-height: 80vh; transform: scale(0.9); transition: transform 0.3s ease;
        }
        #interpretation-modal-overlay.visible #interpretation-modal { transform: scale(1); }
        #modal-header { display: flex; justify-content: space-between; align-items: center; padding: 10px 20px; border-bottom: 1px solid var(--border-color); flex-shrink: 0; }
        #modal-tabs { display: flex; gap: 10px; }
        #modal-tabs .modal-tab:hover:not(.active) {
            background-color: transparent !important;
            border-color: transparent !important;
            opacity: 0.8;
        }
        
        /* --- [MODIFIED] 主题切换按钮样式 --- */
        #theme-toggle {
            position: fixed;
            top: 15px;
            right: 15px;
            background: transparent;
            border: none;
            cursor: pointer;
            z-index: 100;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            box-shadow: none;
            padding: 8px;
            font-family: inherit;
        }
        #theme-toggle:hover {
            transform: scale(1.1);
        }
        #theme-toggle:focus, #theme-toggle:active {
            outline: none;
            box-shadow: none;
        }
        .theme-icon {
            font-size: 1.0em; /* 调小字体 */
            color: var(--primary-text);
            line-height: 1;
        }
        /* 默认隐藏“日”图标 */
        #theme-icon-light { display: none; }
        /* 亮色模式下，隐藏“夜”图标 */
        .light-theme #theme-icon-dark { display: none; }
        /* 亮色模式下，显示“日”图标 */
        .light-theme #theme-icon-light { display: inline; }
        
        /* 问题输入框样式 */
        .question-input-container {
            margin: 20px auto;
            width: 90%;
            max-width: 500px;
        }
        #question-input {
            width: 80%;
            max-width: 400px;
            margin: 0 auto;
            padding: 10px 12px;
            border-radius: 10px;
            border: 1px solid var(--border-color);
            background: rgba(0,0,0,0.2);
            color: var(--primary-text);
            font-family: inherit;
            font-size: 1em;
            transition: all 0.3s ease;
            text-align: center;
            display: block;
        }
        #question-input:focus {
            outline: none;
            border-color: var(--title-color);
            box-shadow: 0 0 0 2px color-mix(in srgb, var(--border-color) 45%, transparent);
        }
        @media (max-width: 768px) {
            #question-input {
                width: 85%;
                max-width: 350px;
                padding: 8px 10px;
                font-size: 0.95em;
            }
        }
        :root.light-theme #question-input {
            background: rgba(255,255,255,0.7);
        }
        
        /* --- [REVISED] 历史记录按钮样式 --- */
        #history-button {
            position: fixed;
            top: 15px;
            left: 15px;
            --btn-bg: color-mix(in srgb, var(--container-bg) 65%, transparent);
            --btn-bg-hover: color-mix(in srgb, var(--container-bg) 85%, transparent);
            background: var(--btn-bg); /* 简化为纯底色，移除高光边线 */
            border: none; /* 移除边框 */
            color: var(--primary-text);
            font-family: inherit;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            z-index: 10;
            padding: 8px 12px;
            -webkit-tap-highlight-color: transparent;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transform-origin: left center;
            border-radius: 999px;
            box-shadow: none; /* 移除可见阴影，变得更扁平 */
            transform: translateY(0);
            transition: transform 0.18s ease, box-shadow 0.22s ease, border-color 0.22s ease, background 0.22s ease;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }

        #history-button:hover, #history-button:active, #history-button:focus, #history-button.active {
            color: var(--title-color);
            background: var(--btn-bg-hover);
            /* 小幅提升，但不使用显著边线或发光 */
            box-shadow: 0 6px 16px rgba(0,0,0,0.10);
            transform: translateY(-1px);
            outline: none;
        }

        /* 清除按钮样式 */
        .clear-history-button {
            display: block;
            margin: 15px auto;
            padding: 8px 16px;
            --btn-bg: #c93756;
            --btn-bg-hover: #e04a69;
            font-size: 0.95rem;
            border-radius: 999px;
        }
        
        #history-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            backdrop-filter: blur(5px);
            z-index: 200;
            display: flex;
            justify-content: center;
            align-items: center;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }
        #history-modal-overlay.visible {
            opacity: 1;
            pointer-events: all;
        }
        #history-modal {
            width: 90%;
            max-width: 600px;
            background: var(--modal-bg);
            border-radius: 10px;
            border: 1px solid var(--modal-border);
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
            max-height: 80vh;
            display: flex;
            flex-direction: column;
            transform: scale(0.9);
            transition: transform 0.3s ease;
        }
        #history-modal-overlay.visible #history-modal {
            transform: scale(1);
        }
        #history-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            border-bottom: 1px solid var(--border-color);
        }
        #history-title {
            font-size: 1.3em;
            color: var(--title-color);
            font-weight: bold;
        }
        #history-close-btn {
            background: none;
            border: none;
            color: var(--primary-text);
            font-size: 2em;
            cursor: pointer;
            opacity: 0.7;
            transition: opacity 0.2s;
            padding: 0;
            line-height: 1;
        }
        #history-close-btn:hover {
            opacity: 1;
        }
        #history-content {
            padding: 20px;
            overflow-y: auto;
            max-height: calc(80vh - 60px);
        }
        .history-item {
            padding: 15px;
            border-radius: 8px;
            background: rgba(0,0,0,0.1);
            margin-bottom: 15px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .history-item:hover {
            background: rgba(0,0,0,0.2);
            transform: translateY(-2px);
        }
        .history-date {
            font-size: 0.8em;
            color: var(--primary-text);
            opacity: 0.7;
            margin-bottom: 5px;
        }
        .history-question {
            font-weight: bold;
            margin-bottom: 10px;
        }
        .history-hexagrams {
            display: flex;
            gap: 15px;
        }
        .history-hexagram {
            text-align: center;
        }
        .history-hexagram-name {
            font-size: 1.1em;
            color: var(--title-color);
        }
        .no-history {
            text-align: center;
            padding: 30px;
            color: var(--primary-text);
            opacity: 0.7;
        }
        .modal-tab {
            --btn-bg: color-mix(in srgb, var(--container-bg) 55%, transparent);
            --btn-bg-hover: color-mix(in srgb, var(--container-bg) 75%, transparent);
            background: linear-gradient(180deg, rgba(255,255,255,0.08), rgba(0,0,0,0.16)), var(--btn-bg);
            border: 1px solid color-mix(in srgb, var(--border-color) 65%, transparent);
            color: var(--primary-text);
            opacity: 0.78;
            padding: 8px 12px;
            font-size: 0.85em;
            border-radius: 999px;
            cursor: pointer;
            transition: opacity 0.22s ease, color 0.22s ease, border-color 0.22s ease, background 0.22s ease, transform 0.18s ease;
            box-shadow: none;
        }
        .modal-tab.active {
            opacity: 1;
            color: var(--title-color);
            border-color: color-mix(in srgb, var(--title-color) 55%, var(--border-color));
            background: linear-gradient(180deg, rgba(255,255,255,0.10), rgba(0,0,0,0.12)), color-mix(in srgb, var(--container-bg) 85%, transparent);
            transform: translateY(-1px);
        }
        .modal-tab:hover:not(.active) {
            background: linear-gradient(180deg, rgba(255,255,255,0.10), rgba(0,0,0,0.14)), var(--btn-bg-hover) !important;
            color: var(--primary-text);
            opacity: 0.92;
            transform: translateY(-1px);
        }
        #modal-close-btn { background: none; border: none; color: var(--primary-text); font-size: 1.5em; cursor: pointer; opacity: 0.7; transition: opacity 0.2s; padding: 0; line-height: 1; }
        #modal-close-btn:hover { opacity: 1; }
    /* 弹窗内容：使用较小的行高并采用 pre-line 保留换行但折叠多余空白 */
    #modal-content { padding: 25px; overflow-y: auto; line-height: 1.4; font-size: 1.0em; white-space: pre-line; }
    /* 如果解释文本中包含 <p> 标签，去掉默认段落外边距并同步行高 */
    #modal-content p { margin: 0 0 0.45em; line-height: 1.2; }
        .tab-content { display: none; }
        .tab-content.active { display: block; animation: contentFadeIn 0.5s ease; }
        @keyframes contentFadeIn { from { opacity: 0; } to { opacity: 1; } }

        @media (max-width: 768px) {
            body { align-items: center; padding: 0; }
            .container { padding: 15px; margin: 0 2.5%; width: 95%; border-radius: 8px; overflow: auto; }
            h1 { font-size: 2.5em; }
            .hexagram-display { flex-direction: row; justify-content: space-around; align-items: flex-start; padding: 10px 5px; }
            .hexagram { flex: 1; min-width: 0; padding: 0 5px; }
            .hexagram h3 { font-size: 1em; margin-bottom: 6px; }
            .hexagram-name { font-size: 1.1em; margin-top: 6px; word-break: break-all; }
            .yao { width: 100%; max-width: 80px; height: 14px; margin: 3px auto; }
            .yao svg { height: 3px; }
            .yao-changing-symbol { font-size: 0.8em; right: -16px;}
            #yao-stats-container { padding: 8px; gap: 5px; }
            .change-stat { font-size: 0.7em; padding: 4px 6px; }
            .yao-stats-result { font-size: 1em; }
            button { font-size: 1em; padding: 10px 18px; border-radius: 12px; }
        }
    </style>
</head>
<body>
    
    <!-- [新增] 噪点纹理 -->
    <div class="noise-overlay"></div>

    <!-- 添加页面加载动画 -->
    <div id="page-loader">
        <div class="loader-content">
            <div class="loader-symbol">☯</div>
            <div class="loader-text">加载中...</div>
        </div>
    </div>

    <div id="background-bagua">
        <svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg" fill="none" stroke="currentColor" color="var(--primary-text)">
            <defs>
                <g id="yang-line"><path d="M -4.5,0 L 4.5,0" stroke-width="1.5" stroke-linecap="butt"></path></g>
                <g id="yin-line"><path d="M -4.5,0 L -1.5,0 M 1.5,0 L 4.5,0" stroke-width="1.5" stroke-linecap="butt"></path></g>
            </defs>
            <g stroke-width="0.5">
                <circle cx="50" cy="50" r="48"></circle><circle cx="50" cy="50" r="44"></circle>
                <circle cx="50" cy="50" r="35"></circle><circle cx="50" cy="50" r="34"></circle>
                <circle cx="50" cy="50" r="26"></circle><circle cx="50" cy="50" r="25"></circle>
                <circle cx="50" cy="50" r="17"></circle><circle cx="50" cy="50" r="16"></circle>
            </g>
            <g stroke-width="0">
                <path d="M50 16 A 34 34 0 0 0 50 84 Z" fill="var(--bg-color)"></path>
                <path d="M50 16 A 34 34 0 0 1 50 84 Z" fill="currentColor"></path>
                <circle cx="50" cy="67" r="17" fill="currentColor"></circle>
                <circle cx="50" cy="33" r="17" fill="var(--bg-color)"></circle>
                <circle cx="50" cy="33" r="4" fill="currentColor"></circle>
                <circle cx="50" cy="67" r="4" fill="var(--bg-color)"></circle>
            </g>
            <g transform="translate(50 50)">
                 <g transform="translate(0, -39.5)"><use href="#yang-line" y="3"></use><use href="#yang-line" y="0"></use><use href="#yang-line" y="-3"></use></g>
                 <g transform="rotate(45) translate(0, -39.5)"><use href="#yin-line" y="3"></use><use href="#yang-line" y="0"></use><use href="#yang-line" y="-3"></use></g>
                 <g transform="rotate(90) translate(0, -39.5)"><use href="#yin-line" y="3"></use><use href="#yang-line" y="0"></use><use href="#yin-line" y="-3"></use></g>
                 <g transform="rotate(135) translate(0, -39.5)"><use href="#yin-line" y="3"></use><use href="#yin-line" y="0"></use><use href="#yang-line" y="-3"></use></g>
                 <g transform="rotate(180) translate(0, -39.5)"><use href="#yin-line" y="3"></use><use href="#yin-line" y="0"></use><use href="#yin-line" y="-3"></use></g>
                 <g transform="rotate(225) translate(0, -39.5)"><use href="#yang-line" y="3"></use><use href="#yin-line" y="0"></use><use href="#yin-line" y="-3"></use></g>
                 <g transform="rotate(270) translate(0, -39.5)"><use href="#yang-line" y="3"></use><use href="#yin-line" y="0"></use><use href="#yang-line" y="-3"></use></g>
                 <g transform="rotate(315) translate(0, -39.5)"><use href="#yang-line" y="3"></use><use href="#yin-line" y="0"></use><use href="#yin-line" y="-3"></use></g>
            </g>
        </svg>
    </div>
    <!-- [MODIFIED] 主题切换按钮 -->
    <button id="theme-toggle" title="切换主题">
        <span class="theme-icon" id="theme-icon-dark">夜</span>
        <span class="theme-icon" id="theme-icon-light">日</span>
    </button>
    
    <div class="container" id="main-container">
        <div id="intro-section">
            <h1 class="text-gold-gradient">大衍筮法 · 在线卜卦</h1>
            <div class="section">
                <p><i>心诚则灵，一事一问</i></p>
            </div>
            
            <!-- 添加问题输入框 -->
            <div class="question-input-container">
                <input type="text" id="question-input" placeholder="请输入您想问的问题…也可以不输" maxlength="50">
            </div>
            
            <div class="method-selector">
                <label id="label-random">随机数法</label>
                <label class="method-switch">
                    <input type="checkbox" id="method-toggle" checked>
                    <span class="slider"></span>
                </label>
                <label id="label-yarrow"><b>大衍筮法</b></label>
            </div>
        </div>
        
        <div class="button-wrapper">
            <button id="divine-button">开始卜卦</button>
        </div>

        <div id="result-container">
            <div class="hexagram-display">
                <div class="hexagram">
                    <h3>本卦</h3>
                    <div id="original-hexagram" class="yao-lines"></div>
                    <div id="original-hexagram-name" class="hexagram-name"></div>
                </div>
                <div class="hexagram" id="changed-hexagram-container">
                    <h3>变卦</h3>
                    <div id="changed-hexagram" class="yao-lines"></div>
                    <div id="changed-hexagram-name" class="hexagram-name"></div>
                </div>
            </div>
            <!-- 结果页按钮容器 -->
            <div id="result-actions-wrapper" class="button-wrapper"></div>
        </div>
    </div>
    
    <div id="interactive-animation-container">
        <!-- 进度条 - 无文字说明 -->
        <div id="divination-progress-bar"></div>
        <div id="interaction-prompt"></div>
        <div id="stalks-wrapper"></div>
        <div id="yao-stats-container">
            <div class="yao-stats-title">本爻演算</div>
            <div id="yao-stats-changes" class="yao-stats-changes"></div>
            <div id="yao-stats-result" class="yao-stats-result"></div>
        </div>
    </div>

    <!-- 解释弹窗 HTML -->
    <div id="interpretation-modal-overlay">
        <div id="interpretation-modal">
            <!-- [MODIFIED] 修改了 modal-header 结构以添加新按钮 -->
            <div id="modal-header">
                <div id="modal-tabs">
                    <button id="tab-original" class="modal-tab active">本卦</button>
                    <button id="tab-changed" class="modal-tab">变卦</button>
                </div>
                <div style="display: flex; align-items: center;">
                    <button id="vernacular-toggle-btn" class="modal-tab" style="margin-right: 15px; border-bottom: 2px solid transparent;">说人话</button>
                    <button id="modal-close-btn">&times;</button>
                </div>
            </div>
            <div id="modal-content">
                <div id="content-original" class="tab-content active"></div>
                <div id="content-changed" class="tab-content"></div>
            </div>
        </div>
    </div>
    
    <!-- 历史记录按钮 -->
    <button id="history-button" title="查看历史记录">
        歷史記錄
    </button>
    
    <!-- 历史记录模态框 -->
    <div id="history-modal-overlay">
        <div id="history-modal">
            <div id="history-header">
                <div id="history-title">卜卦历史记录</div>
                <button id="history-close-btn">&times;</button>
            </div>
            <div id="history-content">
                <!-- 历史记录内容将通过JavaScript动态生成 -->
            </div>
        </div>
    </div>

    <script>
    const app = {
        elements: {
            divineButton: document.getElementById('divine-button'),
            interactiveContainer: document.getElementById('interactive-animation-container'),
            interactionPrompt: document.getElementById('interaction-prompt'),
            stalksWrapper: document.getElementById('stalks-wrapper'),
            progressBar: document.getElementById('divination-progress-bar'),
            resultContainer: document.getElementById('result-container'),
            originalHexagram: document.getElementById('original-hexagram'),
            changedHexagram: document.getElementById('changed-hexagram'),
            originalHexagramName: document.getElementById('original-hexagram-name'),
            changedHexagramName: document.getElementById('changed-hexagram-name'),
            mainContainer: document.getElementById('main-container'),
            introSection: document.getElementById('intro-section'),
            changedHexagramContainer: document.getElementById('changed-hexagram-container'),
            methodToggle: document.getElementById('method-toggle'),
            labelYarrow: document.getElementById('label-yarrow'),
            labelRandom: document.getElementById('label-random'),
            yaoStatsContainer: document.getElementById('yao-stats-container'),
            yaoStatsChanges: document.getElementById('yao-stats-changes'),
            yaoStatsResult: document.getElementById('yao-stats-result'),
            resultActionsWrapper: document.getElementById('result-actions-wrapper'),
            interpretationModalOverlay: document.getElementById('interpretation-modal-overlay'),
            // [NEW] 添加新按钮到 elements
            vernacularToggleBtn: document.getElementById('vernacular-toggle-btn'),
        },
        
        state: {
            divinationData: [],
            isMobile: /Mobi|Android/i.test(navigator.userAgent),
            divinationMethod: 'yarrow',
            isParallaxActive: true,
            isCalibrated: false,
            baseBeta: 0,
            baseGamma: 0,
            currentOriginalHexKey: null,
            currentChangedHexKey: null,
            currentQuestion: '',
            divinationHistory: [],
            // [NEW] 添加白话文状态
            isVernacular: false,
            // 进度条相关状态
            totalClicks: 0,
            maxClicks: 18, // 6爻 × 3变 = 18次点击
        },

        performChangeWithInteraction: function(totalSticks, clickRatio) {
            if (totalSticks <= 1) return { total: totalSticks, left: totalSticks, right: 0, leftRem: totalSticks, rightRem: 0, removed: 0, remaining: totalSticks };
            let leftPile = Math.round(totalSticks * clickRatio);
            if (leftPile < 1) leftPile = 1;
            if (leftPile >= totalSticks) leftPile = totalSticks - 1;
            const rightPile = totalSticks - leftPile;
            const rightPileForCounting = rightPile - 1;
            let leftRemainder = leftPile % 4;
            if (leftRemainder === 0) leftRemainder = 4;
            let rightRemainder = rightPileForCounting % 4;
            if (rightRemainder === 0) rightRemainder = 4;
            const totalRemoved = 1 + leftRemainder + rightRemainder;
            const remainingSticks = totalSticks - totalRemoved;
            return { total: totalSticks, left: leftPile, right: rightPile, leftRem: leftRemainder, rightRem: rightRemainder, removed: totalRemoved, remaining: remainingSticks };
        },
        
        getChangeFromUser: function(totalSticks, changeName) {
            return new Promise(resolve => {
                this.elements.interactionPrompt.textContent = `第 ${changeName} 变，请点击分蓍草`;
                this.elements.stalksWrapper.innerHTML = '';
                
                // 使用 DocumentFragment 批量创建和添加蓍草
                const fragment = document.createDocumentFragment();
                const stalks = [];
                
                // 预先计算所有蓍草的随机旋转和位移值，避免在动画中重复计算
                const randomValues = Array.from({ length: totalSticks }, () => ({
                    yOffset: (Math.random() - 0.5) * 10,
                    rotation: (Math.random() - 0.5) * 15
                }));
                
                for (let i = 0; i < totalSticks; i++) {
                    const stalk = document.createElement('div');
                    stalk.className = 'stalk';
                    fragment.appendChild(stalk);
                    stalks.push(stalk);
                }
                
                // 一次性将所有蓍草添加到 DOM
                this.elements.stalksWrapper.appendChild(fragment);
                
                // 使用预计算的随机值进行动画
                gsap.fromTo(stalks, 
                    { x: 0, y: 0, rotation: 0 }, 
                    { 
                        x: (i) => (i - totalSticks / 2) * (this.elements.stalksWrapper.offsetWidth * 0.8 / totalSticks),
                        y: (i) => randomValues[i].yOffset,
                        rotation: (i) => randomValues[i].rotation,
                        duration: 0.5,
                        ease: 'power2.out'
                    });
                
                    const clickHandler = (e) => {
                    this.elements.stalksWrapper.removeEventListener('click', clickHandler);
                    this.elements.stalksWrapper.style.cursor = 'default';
                    
                    // 更新进度条
                    this.state.totalClicks++;
                    this.updateProgressBar();
                    
                    const rect = this.elements.stalksWrapper.getBoundingClientRect();
                    const clickX = e.clientX - rect.left;
                    const clickRatio = clickX / rect.width;
                    const changeResult = this.performChangeWithInteraction(totalSticks, clickRatio);
                    
                    this.elements.interactionPrompt.textContent = `天: ${changeResult.left}, 地: ${changeResult.right}`;
                    
                    const tl = gsap.timeline({ onComplete: () => resolve(changeResult) });
                    const leftStalks = stalks.slice(0, changeResult.left);
                    const rightStalks = stalks.slice(changeResult.left);

                    tl.to(leftStalks, { x: '-=100', rotation: -20, duration: 0.3, ease: 'power2.inOut', stagger: 0.005 });
                    tl.to(rightStalks, { x: '+=100', rotation: 20, duration: 0.3, ease: 'power2.inOut', stagger: 0.005 }, '<');
                    const heldStalk = rightStalks.pop();
                    tl.to(heldStalk, { y: -80, x: '+=20', rotation: 15, duration: 0.3, ease: 'power2.out' }, '-=0.2');
                    const leftRemainderStalks = leftStalks.slice(0, changeResult.leftRem);
                    const rightRemainderStalks = rightStalks.slice(0, changeResult.rightRem);
                    const nonRemainderLeft = leftStalks.filter(s => !leftRemainderStalks.includes(s));
                    const nonRemainderRight = rightStalks.filter(s => !rightRemainderStalks.includes(s));
                    tl.to([...nonRemainderLeft, ...nonRemainderRight], { opacity: 0.3, duration: 0.2 }, '+=0.1');
                    tl.to(leftRemainderStalks, { x: '-=30', scale: 1.2, duration: 0.3, ease: 'power2.out' }, '<');
                    tl.to(rightRemainderStalks, { x: '+=30', scale: 1.2, duration: 0.3, ease: 'power2.out' }, '<');
                    const allRemainders = [heldStalk, ...leftRemainderStalks, ...rightRemainderStalks];
                    const stalksWrapperRect = this.elements.stalksWrapper.getBoundingClientRect();
                    const targetX = (window.innerWidth / 2) - (stalksWrapperRect.left + stalksWrapperRect.width / 2);
                    const targetY = (window.innerHeight / 2) - (stalksWrapperRect.top + stalksWrapperRect.height / 2);
                    tl.to(allRemainders, { x: targetX, y: targetY, scale: 1, duration: 0.5, stagger: 0.05, ease: 'power2.inOut' }, '-=0.3');
                    tl.to(allRemainders, { y: `+=${window.innerHeight / 2 + 100}`, opacity: 0, duration: 0.6, stagger: 0.03, ease: 'power2.in' });
                    const remainingStalks = stalks.filter(s => !allRemainders.includes(s));
                    tl.to(remainingStalks, { x: 0, rotation: 0, opacity: 1, duration: 0.4, ease: 'power2.inOut' }, '-=0.5');
                };
                this.elements.stalksWrapper.addEventListener('click', clickHandler);
                this.elements.stalksWrapper.style.cursor = 'pointer';
            });
        },

        generateYaoInteractively: async function() {
            let sticks = 49;
            const changes = [];
            
            this.elements.yaoStatsChanges.innerHTML = '';
            this.elements.yaoStatsResult.innerHTML = '';
            gsap.to(this.elements.yaoStatsContainer, { opacity: 1, duration: 0.3 });

            for (let i = 0; i < 3; i++) {
                const changeNames = ['一', '二', '三'];
                const changeResult = await this.getChangeFromUser(sticks, changeNames[i]);
                sticks = changeResult.remaining;
                changes.push(changeResult);

                const changeStatEl = document.createElement('div');
                changeStatEl.className = 'change-stat';
                changeStatEl.innerHTML = `<div class="label">第${changeNames[i]}变</div><div class="value">余 ${changeResult.remaining}</div>`;
                this.elements.yaoStatsChanges.appendChild(changeStatEl);
                gsap.from(changeStatEl, { opacity: 0, scale: 0.5, duration: 0.4, ease: 'back.out' });
            }
            const yaoValue = sticks / 4;
            const yaoInfo = this.getYaoInfo(yaoValue);
            
            this.elements.yaoStatsResult.textContent = `本爻蓍草: ${yaoValue * 4} 根`;
            gsap.from(this.elements.yaoStatsResult, { opacity: 0, y: 10, duration: 0.4 });

            return { value: yaoValue, changes: changes, info: yaoInfo };
        },

        animateFinalHexagramFormation: async function(yaoInfos) {
            const finalStalks = Array.from(this.elements.stalksWrapper.querySelectorAll('.stalk')).filter(s => gsap.getProperty(s, "opacity") > 0);
            const flyingHexagram = document.createElement('div');
            flyingHexagram.style.position = 'absolute';
            flyingHexagram.style.display = 'flex';
            flyingHexagram.style.flexDirection = 'column-reverse';
            yaoInfos.forEach(info => {
                const yaoEl = this.createYaoElement(info);
                flyingHexagram.appendChild(yaoEl);
            });
            this.elements.stalksWrapper.appendChild(flyingHexagram);
            flyingHexagram.style.opacity = 0;
            const tl = gsap.timeline();
            tl.to(this.elements.yaoStatsContainer, { opacity: 0, duration: 0.3 });
            tl.to(finalStalks, { x: 0, y: 0, opacity: 0, scale: 0, duration: 0.8, stagger: 0.02, ease: 'power2.in' }, "<");
            tl.to(flyingHexagram, { opacity: 1, duration: 0.5 }, '-=0.5');
            const viewportCenterX = window.innerWidth / 2;
            const viewportCenterY = window.innerHeight / 2;
            const wrapperRect = this.elements.stalksWrapper.getBoundingClientRect();
            tl.to(flyingHexagram, { x: viewportCenterX - wrapperRect.left - wrapperRect.width / 2, y: viewportCenterY - wrapperRect.top - wrapperRect.height / 2, scale: 0, opacity: 0, duration: 1.2, ease: 'power3.in' }, '+=0.5');
            await new Promise(resolve => tl.eventCallback('onComplete', resolve));
        },

        // 更新进度条
        updateProgressBar: function() {
            const progress = (this.state.totalClicks / this.state.maxClicks) * 100;
            gsap.to(this.elements.progressBar, {
                width: `${progress}%`,
                duration: 0.3,
                ease: 'power2.out'
            });
        },

        // 重置进度条
        resetProgressBar: function() {
            this.state.totalClicks = 0;
            gsap.set(this.elements.progressBar, { width: '0%' });
        },

        runYarrowDivination: async function() {
            this.elements.interactiveContainer.classList.add('visible');
            this.elements.yaoStatsContainer.style.opacity = 0;
            this.state.divinationData = [];
            // 重置进度条
            this.resetProgressBar();
            const originalYaoValues = [];
            const originalYaoInfos = [];
            const yaoNames = ['初', '二', '三', '四', '五', '上'];
            for (let i = 0; i < 6; i++) {
                this.elements.interactionPrompt.textContent = `求 ${yaoNames[i]} 爻`;
                await new Promise(r => setTimeout(r, 200));
                const yaoResult = await this.generateYaoInteractively();
                originalYaoValues.push(yaoResult.value);
                originalYaoInfos.push(yaoResult.info);
                this.state.divinationData.push(yaoResult);
            }
            this.elements.interactionPrompt.textContent = '卦象生成...';
            await this.animateFinalHexagramFormation(originalYaoInfos);
            this.elements.interactiveContainer.classList.remove('visible');
            // 隐藏进度条
            gsap.to(this.elements.progressBar, { width: '0%', duration: 0.3 });
            return originalYaoValues;
        },

        runRandomDivination: async function() {
            this.state.divinationData = [];
            const originalYaoValues = [];
            for (let i = 0; i < 6; i++) {
                let sticks = 49;
                const changes = [];
                for (let j = 0; j < 3; j++) {
                    const randomRatio = 0.3 + Math.random() * 0.4;
                    const changeResult = this.performChangeWithInteraction(sticks, randomRatio);
                    sticks = changeResult.remaining;
                    changes.push(changeResult);
                }
                const yaoValue = sticks / 4;
                originalYaoValues.push(yaoValue);
                this.state.divinationData.push({ value: yaoValue, changes: changes, info: this.getYaoInfo(yaoValue) });
            }
            return originalYaoValues;
        },

        startDivination: async function() {
            if (this.state.isMobile && typeof DeviceOrientationEvent.requestPermission === 'function') {
                try { await DeviceOrientationEvent.requestPermission(); } catch (error) { console.error('陀螺仪权限请求失败:', error); }
            }
            this.elements.divineButton.disabled = true;
            this.elements.divineButton.innerHTML = '推演中...<span class="loader"></span>';
            this.elements.resultContainer.style.display = 'none';
            this.elements.originalHexagram.innerHTML = '';
            this.elements.changedHexagram.innerHTML = '';

            // [MODIFIED] 如果是大衍筮法，则暂停视差效果并重置窗口位置
            if (this.state.divinationMethod === 'yarrow') {
                this.state.isParallaxActive = false;
                gsap.to(this.elements.mainContainer, { duration: 0.5, rotationY: 0, rotationX: 0, ease: "power1.out" });
            }

            gsap.to(this.elements.mainContainer, { opacity: 0, duration: 0.5 });
            document.body.classList.add('divining');
            let originalYaoValues;
            if (this.state.divinationMethod === 'yarrow') {
                originalYaoValues = await this.runYarrowDivination();
            } else {
                originalYaoValues = await this.runRandomDivination();
            }

            // [MODIFIED] 推演结束后，重新激活视差效果
            this.state.isParallaxActive = true;
            this.state.isCalibrated = false; // 强制重新校准陀螺仪基准，以获得平滑的过渡

            document.body.classList.remove('divining');
            this.displayHexagrams(originalYaoValues);
            this.displayInterpretations(originalYaoValues);
            this.elements.introSection.style.display = 'none';
            this.elements.divineButton.parentElement.style.display = 'none';
            this.elements.resultContainer.style.display = 'block';
            gsap.to(this.elements.mainContainer, { opacity: 1, duration: 0.5 });
            this.setupResultActions();
        },

        setupResultActions: function() {
            this.elements.resultActionsWrapper.innerHTML = '';
            const interpButton = document.createElement('button');
            interpButton.id = 'interp-button';
            interpButton.textContent = '卦象解释';
            interpButton.addEventListener('click', (e) => {
                this.addGlowEffect(e.currentTarget);
                this.showInterpretationModal();
            });
            this.elements.resultActionsWrapper.appendChild(interpButton);
            const resetButton = document.createElement('button');
            resetButton.id = 'reset-button';
            resetButton.textContent = '再算一卦';
            resetButton.addEventListener('click', (e) => {
                this.addGlowEffect(e.currentTarget);
                this.elements.resultContainer.style.display = 'none';
                this.elements.introSection.style.display = 'block';
                this.elements.divineButton.parentElement.style.display = 'flex';
                this.elements.divineButton.innerHTML = '开始卜卦';
                this.elements.divineButton.disabled = false;
                this.state.isCalibrated = false;
            });
            this.elements.resultActionsWrapper.appendChild(resetButton);
        },

        // [NEW] 新增函数，用于根据 isVernacular 状态更新弹窗内容
        updateModalContent: function() {
            // 更新按钮文本和样式
            this.elements.vernacularToggleBtn.textContent = this.state.isVernacular ? '看原文' : '说人话';
            this.elements.vernacularToggleBtn.style.color = this.state.isVernacular ? 'var(--title-color)' : 'var(--primary-text)';
            this.elements.vernacularToggleBtn.style.borderColor = this.state.isVernacular ? 'var(--title-color)' : 'transparent';

            // 检查白话文数据是否存在
            const hasVernacular = typeof OTHER_HEXAGRAM_DATA !== 'undefined';
            //
            const source = (this.state.isVernacular && hasVernacular) ? OTHER_HEXAGRAM_DATA : HEXAGRAM_DATA;

            const { currentOriginalHexKey, currentChangedHexKey } = this.state;
            
            const contentOriginal = document.getElementById('content-original');
            const contentChanged = document.getElementById('content-changed');

            const originalData = source[currentOriginalHexKey];
            const changedData = currentChangedHexKey ? source[currentChangedHexKey] : null;

            // 填充本卦内容
            if (originalData) {
                contentOriginal.innerHTML = originalData.interpretation;
            } else {
                contentOriginal.innerHTML = "<p>暂无解释。</p>";
            }

            // 填充变卦内容
            if (changedData) {
                contentChanged.innerHTML = changedData.interpretation;
            } else {
                contentChanged.innerHTML = ""; // 如果没有变卦，清空内容
            }

            // 如果点击了“说人话”但 other.js 未加载
            if (this.state.isVernacular && !hasVernacular) {
                console.warn("other.js is not loaded or OTHER_HEXAGRAM_DATA is not defined.");
                // 在现有内容前插入提示，而不是完全替换
                const defaultOriginalData = HEXAGRAM_DATA[currentOriginalHexKey];
                const defaultChangedData = currentChangedHexKey ? HEXAGRAM_DATA[currentChangedHexKey] : null;
                
                contentOriginal.innerHTML = `<p style="color: #f88;">[白话文(other.js)未加载]</p>${defaultOriginalData ? defaultOriginalData.interpretation : ''}`;
                if (defaultChangedData) {
                    contentChanged.innerHTML = `<p style="color: #f88;">[白话文(other.js)未加载]</p>${defaultChangedData.interpretation}`;
                }
            }
        },

        // [MODIFIED] 修改 showInterpretationModal 以使用 updateModalContent
        showInterpretationModal: function() {
            // 暂停视差效果
            this.state.isParallaxActive = false;
            gsap.to(this.elements.mainContainer, { duration: 0.5, rotationY: 0, rotationX: 0, ease: "power1.out" });

            // 重置白话文状态
            this.state.isVernacular = false; 

            const { currentOriginalHexKey, currentChangedHexKey } = this.state;
            // 初始加载时，只从 HEXAGRAM_DATA 获取卦名
            const originalData = HEXAGRAM_DATA[currentOriginalHexKey];
            const changedData = currentChangedHexKey ? HEXAGRAM_DATA[currentChangedHexKey] : null;

            if (!originalData) return;

            const tabOriginal = document.getElementById('tab-original');
            const tabChanged = document.getElementById('tab-changed');
            const contentOriginal = document.getElementById('content-original');
            const contentChanged = document.getElementById('content-changed');

            // 更新卦名
            tabOriginal.textContent = `本卦：${originalData.name}`;

            if (changedData) {
                tabChanged.textContent = `变卦：${changedData.name}`;
                tabChanged.style.display = 'inline-block';
            } else {
                tabChanged.style.display = 'none';
            }

            // 使用新函数加载默认内容 (isVernacular 此时为 false)
            this.updateModalContent(); 

            // 设置默认激活的选项卡
            tabOriginal.classList.add('active');
            contentOriginal.classList.add('active');
            tabChanged.classList.remove('active');
            contentChanged.classList.remove('active');

            this.elements.interpretationModalOverlay.classList.add('visible');
        },

        getYaoInfo: function(value) {
             switch (value) {
                case 6: return { type: 'yin', isChanging: true, binary: '0', symbol: '×' };
                case 7: return { type: 'yang', isChanging: false, binary: '1', symbol: '' };
                case 8: return { type: 'yin', isChanging: false, binary: '0', symbol: '' };
                case 9: return { type: 'yang', isChanging: true, binary: '1', symbol: '×' };
                default: return { type: 'error', isChanging: false, binary: '', symbol: '' };
            }
        },
        
        getChangedYaoValue: function(value) {
            if (value === 6) return 7;
            if (value === 9) return 8;
            return value;
        },

        createYaoElement: function(info) {
            const yaoDiv = document.createElement('div');
            yaoDiv.className = `yao yao-${info.type}`;
            if(info.type === 'placeholder') return yaoDiv;
            const svgNS = "http://www.w3.org/2000/svg";
            const svg = document.createElementNS(svgNS, "svg");
            svg.setAttribute("viewBox", "0 0 100 10"); 
            svg.setAttribute("preserveAspectRatio", "none");
            if (info.type === 'yang') {
                const line = document.createElementNS(svgNS, "line");
                line.setAttribute("x1", "0"); line.setAttribute("y1", "5"); line.setAttribute("x2", "100"); line.setAttribute("y2", "5");
                line.setAttribute("stroke-width", "10");
                svg.appendChild(line);
            } else if (info.type === 'yin') {
                const line1 = document.createElementNS(svgNS, "line");
                line1.setAttribute("x1", "0"); line1.setAttribute("y1", "5"); line1.setAttribute("x2", "40"); line1.setAttribute("y2", "5");
                line1.setAttribute("stroke-width", "10");
                svg.appendChild(line1);
                const line2 = document.createElementNS(svgNS, "line");
                line2.setAttribute("x1", "60"); line2.setAttribute("y1", "5"); line2.setAttribute("x2", "100"); line2.setAttribute("y2", "5");
                line2.setAttribute("stroke-width", "10");
                svg.appendChild(line2);
            }
            yaoDiv.appendChild(svg);
            if (info.isChanging) {
                yaoDiv.classList.add('yao-changing');
                const symbol = document.createElement('div');
                symbol.className = 'yao-changing-symbol';
                symbol.textContent = info.symbol;
                yaoDiv.appendChild(symbol);
            }
            return yaoDiv;
        },

        displayHexagrams: function(originalYaoValues) {
            this.elements.originalHexagram.innerHTML = '';
            this.elements.changedHexagram.innerHTML = '';
            originalYaoValues.forEach(value => {
                this.elements.originalHexagram.appendChild(this.createYaoElement(this.getYaoInfo(value)));
                this.elements.changedHexagram.appendChild(this.createYaoElement(this.getYaoInfo(this.getChangedYaoValue(value))));
            });
            gsap.from(this.elements.originalHexagram.children, { duration: 2, opacity: 0, stagger: 0.1 });
            gsap.from(this.elements.changedHexagram.children, { duration: 2, opacity: 0, stagger: 0.1 });
        },

        displayInterpretations: function(originalYaoValues) {
            const originalBinary = [...originalYaoValues].map(v => this.getYaoInfo(v).binary).reverse().join('');
            const changedBinary = [...originalYaoValues].map(v => this.getYaoInfo(this.getChangedYaoValue(v)).binary).reverse().join('');
            
            this.state.currentOriginalHexKey = originalBinary;
            this.state.currentChangedHexKey = originalBinary !== changedBinary ? changedBinary : null;

            const originalHexData = HEXAGRAM_DATA[originalBinary] || { name: '未知' };
            const changedHexData = HEXAGRAM_DATA[changedBinary] || { name: '未知' };
            this.elements.originalHexagramName.textContent = `${originalHexData.name}`;
            gsap.from(this.elements.originalHexagramName, { opacity: 0, y: 10, duration: 0.5, ease: 'power1.out' });
            if (originalBinary !== changedBinary) {
                this.elements.changedHexagramContainer.style.display = 'flex';
                this.elements.changedHexagramName.textContent = `${changedHexData.name}`;
                gsap.from(this.elements.changedHexagramName, { opacity: 0, y: 10, duration: 0.5, ease: 'power1.out' });
            } else {
                this.elements.changedHexagramContainer.style.display = 'none';
                this.elements.changedHexagramName.textContent = '';
            }
            
            // 保存卜卦历史记录
            this.saveHistory(
                this.state.currentQuestion,
                originalBinary,
                originalBinary !== changedBinary ? changedBinary : null
            );
        },

        initParallax: function() {
            const container = this.elements.mainContainer;
            const sensitivity = 25;
            if (this.state.isMobile) {
                window.addEventListener('deviceorientation', (e) => {
                    // [MODIFIED] 如果视差效果暂停，则不执行任何操作
                    if (!this.state.isParallaxActive) return;

                    const { beta, gamma } = e;
                    if (beta === null || gamma === null) return;
                    if (!this.state.isCalibrated) {
                        this.state.baseBeta = beta;
                        this.state.baseGamma = gamma;
                        this.state.isCalibrated = true;
                    }
                    const deltaBeta = beta - this.state.baseBeta;
                    const deltaGamma = gamma - this.state.baseGamma;
                    const yOffset = gsap.utils.clamp(-45, 45, deltaBeta) / 45; 
                    const xOffset = gsap.utils.clamp(-45, 45, deltaGamma) / 45;
                    gsap.to(container, { duration: 0.5, rotationY: xOffset * sensitivity, rotationX: -yOffset * sensitivity, ease: "power1.out" });
                });
            } else {
                window.addEventListener('mousemove', (e) => {
                    if (!this.state.isParallaxActive) return;

                    const { clientX, clientY } = e;
                    const { innerWidth, innerHeight } = window;
                    const xOffset = (clientX / innerWidth - 0.5) * 2;
                    const yOffset = (clientY / innerHeight - 0.5) * 2;
                    gsap.to(container, { duration: 0.8, rotationY: xOffset * 7, rotationX: -yOffset * 7, ease: "power1.out" });
                });
            }
        },

        addGlowEffect: function(button) {
            const glow = document.createElement('div');
            glow.className = 'button-glow-effect';
            button.appendChild(glow);
            setTimeout(() => glow.remove(), 600);
        },

        // 保存卜卦历史记录
        saveHistory: function(question, originalHexKey, changedHexKey) {
            const historyItem = {
                date: new Date().toLocaleString(),
                question: question || '无问题',
                originalHexKey: originalHexKey,
                changedHexKey: changedHexKey,
                originalName: HEXAGRAM_DATA[originalHexKey]?.name || '未知',
                changedName: changedHexKey ? (HEXAGRAM_DATA[changedHexKey]?.name || '未知') : null
            };
            
            // 从本地存储获取历史记录
            let history = JSON.parse(localStorage.getItem('bagua-history') || '[]');
            
            // 添加新记录到开头
            history.unshift(historyItem);
            
            // 限制历史记录数量为99条
            if (history.length > 99) {
                history = history.slice(0, 99);
            }
            
            // 保存到本地存储
            localStorage.setItem('bagua-history', JSON.stringify(history));
            
            // 更新当前状态
            this.state.divinationHistory = history;
        },
        
        // 显示历史记录
        showHistoryModal: function() {
            const historyContent = document.getElementById('history-content');
            historyContent.innerHTML = '';
            
            // 从本地存储获取历史记录
            const history = JSON.parse(localStorage.getItem('bagua-history') || '[]');
            this.state.divinationHistory = history;
            
            if (history.length === 0) {
                historyContent.innerHTML = '<div class="no-history">暂无卜卦历史记录</div>';
            } else {
                // 添加清除按钮
                const clearButton = document.createElement('button');
                clearButton.className = 'clear-history-button';
                clearButton.textContent = '归入混元';
                clearButton.addEventListener('click', (e) => {
                    e.stopPropagation();
                    if (confirm('历史记录全部会被删除，确定吗？')) {
                        localStorage.removeItem('bagua-history');
                        this.state.divinationHistory = [];
                        this.showHistoryModal();
                    }
                });
                historyContent.appendChild(clearButton);
                
                history.forEach((item, index) => {
                    const historyItem = document.createElement('div');
                    historyItem.className = 'history-item';
                    historyItem.dataset.index = index;
                    
                    const dateEl = document.createElement('div');
                    dateEl.className = 'history-date';
                    dateEl.textContent = item.date;
                    
                    const questionEl = document.createElement('div');
                    questionEl.className = 'history-question';
                    questionEl.textContent = item.question;
                    
                    const hexagramsEl = document.createElement('div');
                    hexagramsEl.className = 'history-hexagrams';
                    
                    const originalEl = document.createElement('div');
                    originalEl.className = 'history-hexagram';
                    originalEl.innerHTML = `<div class="history-hexagram-name">${item.originalName}卦</div>`;
                    
                    hexagramsEl.appendChild(originalEl);
                    
                    if (item.changedName) {
                        const changedEl = document.createElement('div');
                        changedEl.className = 'history-hexagram';
                        changedEl.innerHTML = `<div class="history-hexagram-name">${item.changedName}卦</div>`;
                        hexagramsEl.appendChild(changedEl);
                    }
                    
                    historyItem.appendChild(dateEl);
                    historyItem.appendChild(questionEl);
                    historyItem.appendChild(hexagramsEl);
                    
                    // 点击历史记录项查看详情
                    historyItem.addEventListener('click', () => {
                        document.getElementById('history-modal-overlay').classList.remove('visible');
                        this.showHistoryDetail(item);
                    });
                    
                    historyContent.appendChild(historyItem);
                });
            }
            
            document.getElementById('history-modal-overlay').classList.add('visible');
        },
        
        // 显示历史记录详情
        showHistoryDetail: function(item) {
            // 设置当前的卦象 key，以便“说人话”按钮可以工作
            this.state.currentOriginalHexKey = item.originalHexKey;
            this.state.currentChangedHexKey = item.changedHexKey;

            // 显示解释弹窗
            this.showInterpretationModal();
        },
        
        // [MODIFIED] 修改 init 函数以包含新按钮的逻辑
        init: function() {
            // 加载历史记录
            this.state.divinationHistory = JSON.parse(localStorage.getItem('bagua-history') || '[]');
            
            const historyButton = document.getElementById('history-button');
            const historyModalOverlay = document.getElementById('history-modal-overlay');
            const historyCloseBtn = document.getElementById('history-close-btn');

            historyButton.addEventListener('click', () => {
                historyButton.classList.add('active');
                this.showHistoryModal();
            });
            
            const closeHistoryModal = () => {
                historyModalOverlay.classList.remove('visible');
                historyButton.classList.remove('active');
            };

            historyModalOverlay.addEventListener('click', (e) => {
                if (e.target === historyModalOverlay) {
                    closeHistoryModal();
                }
            });
            historyCloseBtn.addEventListener('click', closeHistoryModal);

            this.elements.methodToggle.addEventListener('change', (e) => {
                this.state.divinationMethod = e.target.checked ? 'yarrow' : 'random';
                this.elements.labelYarrow.style.opacity = e.target.checked ? 1 : 0.7;
                this.elements.labelRandom.style.opacity = e.target.checked ? 0.7 : 1;
            });

            this.elements.divineButton.addEventListener('click', (e) => {
                this.addGlowEffect(e.currentTarget);
                const questionInput = document.getElementById('question-input');
                this.state.currentQuestion = questionInput.value.trim();
                this.startDivination();
            });

            // --- 弹窗事件监听 ---

            // [NEW] "说人话" 按钮点击事件
            this.elements.vernacularToggleBtn.addEventListener('click', () => {
                this.state.isVernacular = !this.state.isVernacular; // 切换状态
                this.updateModalContent(); // 更新两个选项卡的内容
            });

            // 弹窗关闭 (点击遮罩层)
            this.elements.interpretationModalOverlay.addEventListener('click', (e) => {
                if (e.target === this.elements.interpretationModalOverlay) {
                    this.elements.interpretationModalOverlay.classList.remove('visible');
                    this.state.isParallaxActive = true;
                    this.state.isCalibrated = false; 
                    this.state.isVernacular = false; // [NEW] 重置状态
                }
            });
            // 弹窗关闭 (点击 "X" 按钮)
            document.getElementById('modal-close-btn').addEventListener('click', () => {
                this.elements.interpretationModalOverlay.classList.remove('visible');
                this.state.isParallaxActive = true;
                this.state.isCalibrated = false; 
                this.state.isVernacular = false; // [NEW] 重置状态
            });

            document.getElementById('tab-original').addEventListener('click', () => {
                document.getElementById('tab-changed').classList.remove('active');
                document.getElementById('content-changed').classList.remove('active');
                document.getElementById('tab-original').classList.add('active');
                document.getElementById('content-original').classList.add('active');
            });
            
            document.getElementById('tab-changed').addEventListener('click', () => {
                document.getElementById('tab-original').classList.remove('active');
                document.getElementById('content-original').classList.remove('active');
                document.getElementById('tab-changed').classList.add('active');
                document.getElementById('content-changed').classList.add('active');
            });

            this.initParallax();
        }
    };

    window.onload = () => {
        // 隐藏加载动画
        setTimeout(() => {
            const pageLoader = document.getElementById('page-loader');
            if (pageLoader) {
                pageLoader.style.opacity = '0';
                setTimeout(() => {
                    pageLoader.style.visibility = 'hidden';
                }, 500);
            }
        }, 800);
        
        // 确保在 data.js 加载完毕后初始化
        if (typeof HEXAGRAM_DATA !== 'undefined') {
            app.init();
        } else {
            // 如果 data.js 延迟加载，设置一个短延时
            setTimeout(() => {
                 // 再次检查，以防 data.js 和 other.js 都加载慢
                 if (typeof app.init === 'function') {
                    app.init();
                 } else {
                    console.error("App 核心未定义。");
                 }
            }, 100);
        }
        gsap.globalTimeline.timeScale(2.2);
        
        // 初始化主题
        initTheme();
    };
    
    // 主题切换功能
    function initTheme() {
        const themeToggle = document.getElementById('theme-toggle');
        const savedTheme = localStorage.getItem('bagua-theme');
        
        // 应用保存的主题
        if (savedTheme === 'light') {
            document.documentElement.classList.add('light-theme');
        }
        
        themeToggle.addEventListener('click', () => {
            document.documentElement.classList.toggle('light-theme');
            const currentTheme = document.documentElement.classList.contains('light-theme') ? 'light' : 'dark';
            localStorage.setItem('bagua-theme', currentTheme);
        });
    }
    </script>
</body>
</html>

